<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IDEA SCAN 2.0 â€” Entrada con AI</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>ğŸ¤–</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;800;900&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="../css/app.css">
<style>
/* â”€â”€ AI Entry specific â”€â”€ */
.ai-entry-layout {
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 16px;
  height: calc(100vh - var(--header-h) - 40px);
  align-items: start;
}

@media (max-width: 900px) {
  .ai-entry-layout {
    grid-template-columns: 1fr;
    height: auto;
  }
}

/* Camera box */
.camera-box {
  background: #0a0a1e; border-radius: 16px;
  overflow: hidden; position: relative;
  aspect-ratio: 4/3;
}
.camera-box video, .camera-box img {
  width: 100%; height: 100%; object-fit: cover; display: block;
}
.camera-guides {
  position: absolute; inset: 0; pointer-events: none;
}
.camera-guide-corner {
  position: absolute; width: 32px; height: 32px;
  border: 3px solid var(--cyan);
}
.camera-guide-corner.tl { top:12px; left:12px; border-right:none; border-bottom:none; border-radius:3px 0 0 0; }
.camera-guide-corner.tr { top:12px; right:12px; border-left:none; border-bottom:none; border-radius:0 3px 0 0; }
.camera-guide-corner.bl { bottom:12px; left:12px; border-right:none; border-top:none; border-radius:0 0 0 3px; }
.camera-guide-corner.br { bottom:12px; right:12px; border-left:none; border-top:none; border-radius:0 0 3px 0; }

.scan-line {
  position: absolute; left:12px; right:12px; height:2px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
  animation: scanLine 2.5s ease-in-out infinite;
  display: none;
}
@keyframes scanLine { 0%,100%{top:10%} 50%{top:85%} }

.camera-status {
  position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,.7); backdrop-filter: blur(8px);
  color: white; font-size: 12px; font-weight: 600;
  padding: 6px 16px; border-radius: 20px;
  white-space: nowrap; max-width: 90%;
  text-overflow: ellipsis; overflow: hidden;
}

.camera-controls {
  display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;
}

/* Capture button */
.capture-btn {
  flex: 1; padding: 14px;
  background: linear-gradient(135deg, var(--navy), #2d6ef5);
  color: white; border: none; border-radius: 12px;
  font-family: 'Exo 2', sans-serif;
  font-size: 15px; font-weight: 800; cursor: pointer;
  box-shadow: 0 4px 20px rgba(13,43,122,.3);
  transition: all .2s; min-width: 200px;
}
.capture-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 28px rgba(13,43,122,.4); }
.capture-btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }

/* Form panel */
.form-panel {
  background: white; border-radius: 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  display: flex; flex-direction: column;
  max-height: calc(100vh - var(--header-h) - 40px);
  overflow: hidden;
}
.form-panel-header {
  padding: 16px 18px 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
  background: linear-gradient(135deg, rgba(13,43,122,.04), rgba(0,194,255,.04));
}
.form-panel-body { flex: 1; overflow-y: auto; padding: 16px 18px; }
.form-panel-footer { padding: 12px 18px; border-top: 1px solid var(--border); flex-shrink: 0; }

/* Auto-filled field */
.field-auto {
  background: rgba(0,194,255,.04) !important;
  border-color: rgba(0,194,255,.3) !important;
  color: var(--navy) !important; font-weight: 600;
}
.field-auto-label::after {
  content: ' ğŸ¤–';
  font-size: 10px;
}

/* Confidence bar */
.conf-bar {
  height: 3px; border-radius: 2px; background: var(--border);
  margin-top: 4px; overflow: hidden;
}
.conf-fill { height: 100%; border-radius: 2px; transition: width .4s; }

/* Image previews */
.photo-grid {
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 8px; margin-top: 8px;
}
.photo-thumb {
  aspect-ratio: 1; border-radius: 8px; overflow: hidden;
  position: relative; border: 1px solid var(--border);
}
.photo-thumb img { width:100%; height:100%; object-fit:cover; }
.photo-thumb-del {
  position: absolute; top:3px; right:3px;
  width:18px; height:18px; border-radius:50%;
  background: var(--danger); color:white;
  font-size:10px; border:none; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
}

.sku-display {
  background: linear-gradient(135deg, rgba(13,43,122,.06), rgba(0,194,255,.06));
  border: 1.5px solid rgba(0,194,255,.25);
  border-radius: 10px; padding: 12px 16px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px; font-weight: 900;
  color: var(--navy); text-align: center;
  letter-spacing: 2px; margin-bottom: 14px;
}

/* Steps indicator */
.steps {
  display: flex; gap: 0; margin-bottom: 16px; border-radius: 8px; overflow: hidden;
  border: 1px solid var(--border);
}
.step {
  flex: 1; padding: 8px 4px; text-align: center;
  font-size: 10px; font-weight: 700; background: var(--surface);
  color: var(--text-300); border-right: 1px solid var(--border);
  transition: all .3s;
}
.step:last-child { border-right: none; }
.step.active { background: var(--navy); color: white; }
.step.done { background: var(--success); color: white; }
.step-icon { font-size: 14px; display: block; }
</style>
</head>
<body>
<div class="app-shell">
  <nav class="sidebar" id="sidebar"></nav>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="main-content">
    <div class="top-header">
      <button class="hamburger" onclick="toggleSidebar()"><span></span></button>
      <div class="header-title">Entrada <span>con AI</span></div>
      <div class="header-actions">
        <button class="header-btn" onclick="resetForm()" title="Nueva captura">ğŸ”„</button>
      </div>
    </div>

    <div class="page-body">
      <!-- Step progress -->
      <div class="steps" id="steps">
        <div class="step active" id="step1"><span class="step-icon">ğŸ“¸</span>Foto</div>
        <div class="step" id="step2"><span class="step-icon">ğŸ¤–</span>AnÃ¡lisis AI</div>
        <div class="step" id="step3"><span class="step-icon">âœï¸</span>Confirmar</div>
        <div class="step" id="step4"><span class="step-icon">ğŸ’¾</span>Guardar</div>
      </div>

      <div class="ai-entry-layout">
        <!-- Camera / photo area -->
        <div>
          <div class="camera-box" id="cameraBox">
            <video id="camVideo" autoplay playsinline muted style="display:block;"></video>
            <canvas id="camCanvas" style="display:none;"></canvas>
            <div class="camera-guides">
              <div class="camera-guide-corner tl"></div>
              <div class="camera-guide-corner tr"></div>
              <div class="camera-guide-corner bl"></div>
              <div class="camera-guide-corner br"></div>
            </div>
            <div class="scan-line" id="scanLine"></div>
            <div class="camera-status" id="camStatus">Iniciando cÃ¡mara...</div>
          </div>

          <div class="camera-controls">
            <button class="capture-btn" id="captureBtn" onclick="capture()">
              ğŸ“¸ Capturar y Analizar
            </button>
            <label class="btn btn-ghost" style="cursor:pointer;flex-shrink:0;">
              ğŸ“ Subir Foto
              <input type="file" accept="image/*" style="display:none" onchange="uploadPhoto(this.files[0])">
            </label>
          </div>

          <!-- Photo previews -->
          <div style="margin-top:12px;">
            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);margin-bottom:6px;">
              Fotos capturadas (<span id="photoCount">0</span>)
            </div>
            <div class="photo-grid" id="photoGrid"></div>
          </div>
        </div>

        <!-- Form panel -->
        <div class="form-panel">
          <div class="form-panel-header">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
              <div style="font-family:'Exo 2',sans-serif;font-size:13px;font-weight:800;color:var(--navy);">Datos de la Entrada</div>
              <div id="confIndicator" style="display:none;font-size:10px;font-weight:700;"></div>
            </div>
            <!-- SKU display -->
            <div class="sku-display" id="skuDisplay">â€” Pendiente â€”</div>
            <!-- Confidence -->
            <div class="conf-bar" id="confBar" style="display:none;">
              <div class="conf-fill" id="confFill" style="width:0%;background:var(--success);"></div>
            </div>
          </div>

          <div class="form-panel-body">
            <!-- Auto-filled info -->
            <div style="background:rgba(13,43,122,.04);border-radius:8px;padding:10px 12px;margin-bottom:14px;font-size:11px;">
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                <div><span style="color:var(--text-300);">Operador:</span> <strong id="autoOp">â€”</strong></div>
                <div><span style="color:var(--text-300);">Cliente:</span> <strong id="autoCl">â€”</strong></div>
                <div><span style="color:var(--text-300);">AlmacÃ©n:</span> <strong id="autoAlm">â€”</strong></div>
                <div><span style="color:var(--text-300);">Fecha:</span> <strong id="autoDate">â€”</strong></div>
              </div>
            </div>

            <!-- Dynamic fields based on client config -->
            <div id="dynamicFields"></div>
          </div>

          <div class="form-panel-footer">
            <button class="btn btn-primary" style="width:100%;" id="saveBtn" onclick="saveEntry()" disabled>
              ğŸ’¾ Guardar Entrada
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="bottom-nav" id="bottomNav"></div>
<div class="toast" id="globalToast"></div>

<script src="../js/core.js"></script>
<script>
// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let USER;
let clientData = null;   // current client config
let capturedPhotos = []; // array of base64 strings
let aiResults = {};      // parsed AI field values
let currentSKU = '';

// All possible fields
const ALL_FIELDS = [
  { key:'numero_parte',    label:'NÂ° de Parte',        placeholder:'Ej. CP302235' },
  { key:'descripcion',     label:'DescripciÃ³n',         placeholder:'DescripciÃ³n del producto' },
  { key:'po',              label:'PO',                  placeholder:'Ej. A447163' },
  { key:'cantidad',        label:'Piezas / Cantidad',   placeholder:'Ej. 6000', type:'number' },
  { key:'bultos',          label:'Bultos',              placeholder:'Ej. 4', type:'number' },
  { key:'peso',            label:'Peso',                placeholder:'Ej. 9lb o 4kg' },
  { key:'part_model',      label:'Part Model',          placeholder:'Ej. CP302235' },
  { key:'serial_number',   label:'Serial Number',       placeholder:'Ej. 462484-*-*' },
  { key:'tracking_number', label:'Tracking Number',     placeholder:'Ej. 4882 4611 1917' },
  { key:'vendor',          label:'Vendor',              placeholder:'Ej. Nordson MEDICAL' },
  { key:'origin',          label:'Origin',              placeholder:'Ej. USA' },
  { key:'ubicacion',       label:'UbicaciÃ³n / Zona',    placeholder:'Ej. Zona A-01' },
];

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  USER = initPage('ai_entry', ['admin', 'operador']);
  if (!USER) return;

  // Auto-fill header info
  document.getElementById('autoOp').textContent   = USER.nombre;
  document.getElementById('autoDate').textContent  = fmtDate(new Date().toISOString());

  await loadUserContext();
  renderDynamicFields();
  startCameraStream();
});

async function loadUserContext() {
  // Load client
  if (USER.cliente_id) {
    const data = await safeQuery(() => Q.from('clientes').select('*').eq('id', USER.cliente_id).single());
    clientData = data;
    document.getElementById('autoCl').textContent = data?.nombre || 'â€”';
  }

  // Load warehouse
  if (USER.almacen_id) {
    const data = await safeQuery(() => Q.from('almacenes').select('nombre').eq('id', USER.almacen_id).single());
    document.getElementById('autoAlm').textContent = data?.nombre || 'â€”';
  }
}

function renderDynamicFields() {
  // Get fields from client config or show all
  const campos = clientData?.campos_captura || ALL_FIELDS.map(f => f.key);
  // Don't show sku â€” it's auto-generated
  const fieldsToShow = ALL_FIELDS.filter(f => campos.includes(f.key));

  document.getElementById('dynamicFields').innerHTML = fieldsToShow.map(f => `
    <div class="form-group">
      <label class="form-label" id="lbl_${f.key}">${f.label}</label>
      <input class="form-input" id="fld_${f.key}"
        type="${f.type||'text'}" placeholder="${f.placeholder}"
        oninput="aiResults.${f.key}=this.value">
    </div>`).join('');
}

// â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCameraStream() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:'environment' }, width: { ideal:1280 }, height: { ideal:960 } }
    });
    const video = document.getElementById('camVideo');
    video.srcObject = stream;
    document.getElementById('camStatus').textContent = 'CÃ¡mara lista â€” apunta al bulto y captura';
  } catch(e) {
    document.getElementById('camStatus').textContent = 'âš ï¸ Sin acceso a cÃ¡mara â€” usa "Subir Foto"';
    document.getElementById('captureBtn').textContent = 'ğŸ“ Subir Foto';
    document.getElementById('captureBtn').onclick = () => document.querySelector('input[type=file]').click();
  }
}

async function capture() {
  const video = document.getElementById('camVideo');
  const canvas = document.getElementById('camCanvas');
  if (!video.videoWidth) { showToast('CÃ¡mara no disponible', 'warning'); return; }
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const base64 = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
  await analyzePhoto(base64);
}

async function uploadPhoto(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async ev => await analyzePhoto(ev.target.result.split(',')[1]);
  reader.readAsDataURL(file);
}

// â”€â”€ AI Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyzePhoto(base64) {
  // Show scanning animation
  setStep(2);
  document.getElementById('scanLine').style.display = 'block';
  document.getElementById('captureBtn').disabled = true;
  document.getElementById('captureBtn').textContent = 'ğŸ” Analizando...';
  document.getElementById('camStatus').textContent = 'Enviando a Claude Vision...';

  const campos = clientData?.campos_captura || ALL_FIELDS.map(f => f.key);
  const fieldsList = ALL_FIELDS.filter(f => campos.includes(f.key)).map(f => f.label).join(', ');

  const prompt = `Eres el sistema de captura de almacÃ©n IDEA SCAN. Analiza esta imagen de un bulto/caja/etiqueta de mercancÃ­a.

Extrae la siguiente informaciÃ³n visible en la imagen:
${fieldsList}

Responde ÃšNICAMENTE con este JSON (sin markdown ni texto extra):
{
  "numero_parte": "valor o null",
  "descripcion": "valor o null",
  "po": "valor o null",
  "cantidad": "valor o null",
  "bultos": "valor o null",
  "peso": "valor o null",
  "part_model": "valor o null",
  "serial_number": "valor o null",
  "tracking_number": "valor o null",
  "vendor": "valor o null",
  "origin": "valor o null",
  "confianza": 0.0
}`;

  try {
    const data = await callVision(base64, 'image/jpeg', prompt);

    // Parse result
    let parsed = null;
    const candidates = [data, data?.text, data?.content].filter(Boolean);
    for (const c of candidates) {
      if (typeof c === 'object' && c.confianza !== undefined) { parsed = c; break; }
      if (typeof c === 'string') {
        try {
          const m = c.match(/\{[\s\S]*\}/);
          if (m) { parsed = JSON.parse(m[0]); break; }
        } catch {}
      }
    }
    // Use EF structured response directly
    if (!parsed && data?.sku) parsed = { ...data, confianza: data.confidence || 0.7 };
    if (!parsed) parsed = {};

    // Fill fields
    const campos = clientData?.campos_captura || ALL_FIELDS.map(f => f.key);
    campos.forEach(key => {
      const val = parsed[key];
      const el = document.getElementById(`fld_${key}`);
      if (el && val && val !== 'null') {
        el.value = val;
        el.classList.add('field-auto');
        aiResults[key] = val;
      }
    });

    // Confidence
    const conf = parsed.confianza || data?.confidence || 0;
    const confPct = Math.round((typeof conf === 'number' ? conf : parseFloat(conf)||0) * 100);
    document.getElementById('confBar').style.display = 'block';
    document.getElementById('confFill').style.width = Math.min(confPct, 100) + '%';
    document.getElementById('confFill').style.background = confPct > 75 ? 'var(--success)' : confPct > 50 ? 'var(--warning)' : 'var(--danger)';
    document.getElementById('confIndicator').style.display = '';
    document.getElementById('confIndicator').textContent = `${confPct}% confianza`;
    document.getElementById('confIndicator').style.color = confPct > 75 ? 'var(--success)' : 'var(--warning)';

    // Add photo to gallery
    addPhotoToGallery(base64);

    setStep(3);
    document.getElementById('camStatus').textContent = `âœ… AnÃ¡lisis completado â€” ${confPct}% confianza`;
    document.getElementById('saveBtn').disabled = false;
    generateSKUDisplay();

  } catch(e) {
    document.getElementById('camStatus').textContent = 'âš ï¸ Error AI â€” campos capturados manualmente';
    addPhotoToGallery(base64);
    document.getElementById('saveBtn').disabled = false;
  } finally {
    document.getElementById('scanLine').style.display = 'none';
    document.getElementById('captureBtn').disabled = false;
    document.getElementById('captureBtn').textContent = 'ğŸ“¸ Capturar otra';
  }
}

async function generateSKUDisplay() {
  const codigo = clientData?.codigo || 'SKU';
  const sku = await generateSKU(codigo);
  currentSKU = sku;
  document.getElementById('skuDisplay').textContent = sku;
}

function addPhotoToGallery(base64) {
  capturedPhotos.push(base64);
  const i = capturedPhotos.length - 1;
  document.getElementById('photoCount').textContent = capturedPhotos.length;
  const grid = document.getElementById('photoGrid');
  const div = document.createElement('div');
  div.className = 'photo-thumb';
  div.innerHTML = `<img src="data:image/jpeg;base64,${base64}">
    <button class="photo-thumb-del" onclick="removePhoto(${i})">âœ•</button>`;
  grid.appendChild(div);
}

function removePhoto(i) {
  capturedPhotos.splice(i, 1);
  document.getElementById('photoCount').textContent = capturedPhotos.length;
  document.getElementById('photoGrid').children[i]?.remove();
}

// â”€â”€ Save entry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveEntry() {
  if (!clientData) { showToast('Usuario sin cliente asignado â€” contacta al administrador', 'warning'); return; }
  if (!capturedPhotos.length) { showToast('Captura al menos una foto', 'warning'); return; }

  setStep(4);
  const btn = document.getElementById('saveBtn');
  btn.disabled = true; btn.textContent = 'â³ Guardando...';

  try {
    const sku = currentSKU || await generateSKU(clientData.codigo || 'SKU');
    const folio = `ENT-${Date.now().toString(36).toUpperCase()}`;

    // Upload images to Supabase storage (if available) or store as base64 refs
    const imageUrls = capturedPhotos.map((b64, i) => {
      // Store as data URL for now â€” in production, upload to Storage
      return `data:image/jpeg;base64,${b64.slice(0, 50)}...`; // truncate for DB
    });

    // Build entry record
    const record = {
      sku,
      folio_entrada: folio,
      cliente_id:    USER.cliente_id,
      almacen_id:    USER.almacen_id,
      operador_id:   USER.id,
      fecha_entrada: todayISO(),
      estado:        'activo',
      imagenes:      imageUrls,
      // Dynamic fields
      numero_parte:    getValue('numero_parte'),
      descripcion:     getValue('descripcion'),
      po:              getValue('po'),
      cantidad:        parseInt(getValue('cantidad')) || 0,
      bultos:          parseInt(getValue('bultos')) || 0,
      peso:            getValue('peso'),
      part_model:      getValue('part_model'),
      serial_number:   getValue('serial_number'),
      tracking_number: getValue('tracking_number'),
      vendor:          getValue('vendor'),
      origin:          getValue('origin'),
      ubicacion:       getValue('ubicacion'),
    };

    const { data: saved, error } = await Q.from('inventario').insert(record).select('id').single();
    if (error) throw error;

    // Generate label
    await Q.from('labels').insert({
      inventario_id: saved.id,
      sku,
      contenido: record,
      impreso_por: USER.id,
      impreso_at: new Date().toISOString(),
    });

    showToast(`âœ… Entrada guardada â€” SKU: ${sku}`, 'success', 4000);
    setStep(4, true);

    // Auto-reset after 3s
    setTimeout(resetForm, 3000);

  } catch(e) {
    showToast('Error al guardar: ' + e.message, 'error');
    btn.disabled = false;
    btn.textContent = 'ğŸ’¾ Guardar Entrada';
    setStep(3);
  }
}

function getValue(key) {
  return document.getElementById(`fld_${key}`)?.value?.trim() || null;
}

// â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetForm() {
  capturedPhotos = [];
  aiResults = {};
  currentSKU = '';
  setStep(1);
  document.getElementById('photoGrid').innerHTML = '';
  document.getElementById('photoCount').textContent = '0';
  document.getElementById('skuDisplay').textContent = 'â€” Pendiente â€”';
  document.getElementById('confBar').style.display = 'none';
  document.getElementById('confIndicator').style.display = 'none';
  document.getElementById('saveBtn').disabled = true;
  document.getElementById('camStatus').textContent = 'Listo â€” captura una foto para analizar';
  // Clear fields
  document.querySelectorAll('#dynamicFields input').forEach(el => {
    el.value = ''; el.classList.remove('field-auto');
  });
}

// â”€â”€ Steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStep(n, done = false) {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById(`step${i}`);
    if (!el) continue;
    el.className = 'step';
    if (i < n) el.classList.add('done');
    else if (i === n) el.classList.add(done ? 'done' : 'active');
  }
}
</script>
</body>
</html>
