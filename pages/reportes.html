<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IDEA SCAN 2.0 â€” Reportes</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>ğŸ“Š</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;800;900&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" href="../css/app.css">
<style>
/* â”€â”€ Report cards â”€â”€ */
.report-grid {
  display: grid; grid-template-columns: repeat(2, 1fr);
  gap: 16px; margin-bottom: 24px;
}
.report-card {
  background: white; border-radius: 16px;
  border: 1px solid var(--border);
  padding: 24px 22px; cursor: pointer;
  transition: all .2s; box-shadow: var(--shadow);
  display: flex; align-items: center; gap: 18px;
}
.report-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); border-color: var(--cyan); }
.report-card-icon {
  width: 56px; height: 56px; border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; flex-shrink: 0;
}
.report-card-info { flex: 1; }
.report-card-title { font-family:'Exo 2',sans-serif; font-size:16px; font-weight:800; color:var(--navy); }
.report-card-sub { font-size:12px; color:var(--text-300); margin-top:3px; }

/* â”€â”€ Report modal â”€â”€ */
.report-table-wrap {
  overflow-x: auto; border: 1px solid var(--border);
  border-radius: 10px; max-height: 400px; overflow-y: auto;
}

/* â”€â”€ Date range â”€â”€ */
.date-range {
  display: flex; gap: 10px; align-items: center;
  background: var(--surface2); border-radius: 10px;
  padding: 12px 16px; margin-bottom: 16px; flex-wrap: wrap;
}
.date-range label { font-size:11px; font-weight:700; color:var(--text-500); }
.date-range input[type=date] {
  padding: 7px 10px; border: 1px solid var(--border);
  border-radius: 8px; font-size: 13px; color: var(--navy);
  background: white; outline: none;
}
.date-range input[type=date]:focus { border-color: var(--cyan); }

/* â”€â”€ Format buttons â”€â”€ */
.format-btns { display: flex; gap: 6px; flex-wrap: wrap; }
.fmt-btn {
  padding: 6px 12px; border-radius: 7px;
  border: 1px solid var(--border); background: white;
  font-size: 11px; font-weight: 700; cursor: pointer;
  color: var(--text-700); transition: all .18s;
}
.fmt-btn:hover { border-color: var(--cyan); color: var(--navy); }
.fmt-btn.active { background: var(--navy); color: white; border-color: var(--navy); }

/* â”€â”€ Mobile â”€â”€ */
@media (max-width: 768px) {
  .reports-page { display: none !important; }
  .mobile-reports-msg {
    display: flex !important;
    flex-direction: column; align-items: center; justify-content: center;
    height: calc(100vh - var(--header-h));
    text-align: center; padding: 30px;
  }
}
@media (min-width: 769px) {
  .mobile-reports-msg { display: none !important; }
}
</style>
</head>
<body>
<div class="app-shell">
  <nav class="sidebar" id="sidebar"></nav>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="main-content">
    <div class="top-header">
      <button class="hamburger" onclick="toggleSidebar()"><span></span></button>
      <div class="header-title">Reportes <span>WMS</span></div>
    </div>

    <!-- Desktop content -->
    <div class="page-body reports-page">
      <div class="section-title mb-20">ğŸ“Š Selecciona el tipo de reporte</div>

      <div class="report-grid">
        <div class="report-card" onclick="openReport('entradas')">
          <div class="report-card-icon" style="background:rgba(34,199,122,.1)">ğŸ“¥</div>
          <div class="report-card-info">
            <div class="report-card-title">Reporte de Entradas</div>
            <div class="report-card-sub">SKUs capturados con AI, detalle por operador y fecha</div>
          </div>
          <div style="font-size:22px;color:var(--border);">â€º</div>
        </div>

        <div class="report-card" onclick="openReport('salidas')">
          <div class="report-card-icon" style="background:rgba(239,68,68,.08)">ğŸ“¤</div>
          <div class="report-card-info">
            <div class="report-card-title">Reporte de Salidas</div>
            <div class="report-card-sub">Ã“rdenes completadas, SKUs dados de salida, confirmaciones</div>
          </div>
          <div style="font-size:22px;color:var(--border);">â€º</div>
        </div>

        <div class="report-card" onclick="openReport('inventario')">
          <div class="report-card-icon" style="background:rgba(13,43,122,.08)">ğŸ“¦</div>
          <div class="report-card-info">
            <div class="report-card-title">Reporte de Inventario</div>
            <div class="report-card-sub">Estado completo del inventario con rango de fechas</div>
          </div>
          <div style="font-size:22px;color:var(--border);">â€º</div>
        </div>

        <div class="report-card" onclick="openReport('paqueteria')">
          <div class="report-card-icon" style="background:rgba(139,92,246,.08)">ğŸ“¦</div>
          <div class="report-card-info">
            <div class="report-card-title">Reporte de PaqueterÃ­a</div>
            <div class="report-card-sub">Paquetes despachados, carriers, tracking numbers</div>
          </div>
          <div style="font-size:22px;color:var(--border);">â€º</div>
        </div>
      </div>
    </div>

    <!-- Mobile message -->
    <div class="mobile-reports-msg">
      <div style="font-size:48px;margin-bottom:14px;">ğŸ’»</div>
      <div style="font-size:16px;font-weight:700;color:var(--navy);">Reportes solo disponibles en PC</div>
      <div style="font-size:13px;color:var(--text-300);margin-top:6px;">Este mÃ³dulo estÃ¡ optimizado para pantallas de escritorio</div>
    </div>
  </div>
</div>

<!-- â•â• MODAL: Reporte detail â•â• -->
<div class="modal-overlay" id="reportModal" onclick="if(event.target===this)closeReport()">
  <div class="modal modal-xl" style="max-height:90vh;">
    <div class="modal-header">
      <div class="modal-icon" id="rIcon" style="background:rgba(13,43,122,.08)">ğŸ“Š</div>
      <div>
        <div class="modal-title" id="rTitle"></div>
        <div class="modal-sub" id="rSub"></div>
      </div>
      <button class="modal-close" onclick="closeReport()">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- Filters -->
      <div class="date-range" id="rFilters">
        <div>
          <label>Desde</label>
          <input type="date" id="rDateFrom">
        </div>
        <div>
          <label>Hasta</label>
          <input type="date" id="rDateTo">
        </div>
        <button class="btn btn-primary btn-sm" onclick="loadReport()">ğŸ” Generar</button>
      </div>

      <!-- Summary row -->
      <div id="rSummary" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px;"></div>

      <!-- Table -->
      <div class="report-table-wrap">
        <table class="data-table" id="rTable">
          <thead id="rTableHead"></thead>
          <tbody id="rTableBody">
            <tr><td colspan="10" class="empty-state">
              <div class="empty-icon">ğŸ“Š</div>
              <div class="empty-text">Selecciona un rango de fechas y genera el reporte</div>
            </td></tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <div class="format-btns">
        <button class="fmt-btn active" onclick="setFmt('xlsx', this)">Excel</button>
        <button class="fmt-btn" onclick="setFmt('csv', this)">CSV</button>
        <button class="fmt-btn" onclick="setFmt('pdf', this)">PDF</button>
      </div>
      <div style="flex:1;"></div>
      <button class="btn btn-ghost btn-sm" onclick="closeReport()">Cerrar</button>
      <button class="btn btn-primary btn-sm" onclick="downloadReport()">ğŸ“¥ Descargar</button>
      <button class="btn btn-ghost btn-sm" onclick="printReport()">ğŸ–¨ï¸ Imprimir</button>
    </div>
  </div>
</div>

<div class="toast" id="globalToast"></div>

<script src="../js/core.js"></script>
<script>
// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let USER;
let currentReportType = null;
let currentReportData = [];
let currentFmt = 'xlsx';
let clientMap = {};
let almacenMap = {};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  USER = initPage('reportes', ['admin', 'supervisor', 'cliente']);
  if (!USER) return;
  await loadMeta();
  // Set default date range: today
  const today = todayISO();
  document.getElementById('rDateFrom').value = today;
  document.getElementById('rDateTo').value   = today;
});

async function loadMeta() {
  const [cls, alms] = await Promise.all([
    safeQuery(() => Q.from('clientes').select('id,nombre,codigo,color')),
    safeQuery(() => Q.from('almacenes').select('id,nombre')),
  ]);
  (cls||[]).forEach(c => clientMap[c.id] = c);
  (alms||[]).forEach(a => almacenMap[a.id] = a.nombre);
}

// â”€â”€ Open report modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const REPORT_CONFIG = {
  entradas: {
    icon:'ğŸ“¥', iconBg:'rgba(34,199,122,.1)',
    title:'Reporte de Entradas', sub:'Entradas registradas en el sistema',
    showDateRange: false, // defaults to today
    cols: ['SKU','NÂ° Parte','DescripciÃ³n','Cantidad','Bultos','Tracking','Cliente','AlmacÃ©n','Operador','Fecha Entrada'],
    keys: ['sku','numero_parte','descripcion','cantidad','bultos','tracking_number','cliente','almacen','operador','fecha_entrada'],
  },
  salidas: {
    icon:'ğŸ“¤', iconBg:'rgba(239,68,68,.08)',
    title:'Reporte de Salidas', sub:'Ã“rdenes de salida completadas',
    showDateRange: false,
    cols: ['SKU','DescripciÃ³n','Cantidad','Orden','Transporte','Sello','Operador','Confirmado a las'],
    keys: ['sku','descripcion','cantidad','folio_orden','transporte','sello','operador','confirmado_at'],
  },
  inventario: {
    icon:'ğŸ“¦', iconBg:'rgba(13,43,122,.08)',
    title:'Reporte de Inventario', sub:'Estado del inventario por rango de fechas',
    showDateRange: true,
    cols: ['SKU','NÂ° Parte','DescripciÃ³n','Cantidad','Bultos','Peso','Tracking','PO','Vendor','Origin','Cliente','AlmacÃ©n','UbicaciÃ³n','Estado','Fecha Entrada'],
    keys: ['sku','numero_parte','descripcion','cantidad','bultos','peso','tracking_number','po','vendor','origin','cliente','almacen','ubicacion','estado','fecha_entrada'],
  },
  paqueteria: {
    icon:'ğŸ“¦', iconBg:'rgba(139,92,246,.08)',
    title:'Reporte de PaqueterÃ­a', sub:'Paquetes despachados y en trÃ¡nsito',
    showDateRange: false,
    cols: ['CÃ³digo','Carrier','Tracking','Bultos','Cliente','Estado','Operador','Fecha'],
    keys: ['codigo','carrier','tracking_number','bultos','cliente','estado','operador','created_at'],
  },
};

function openReport(type) {
  currentReportType = type;
  currentReportData = [];
  const cfg = REPORT_CONFIG[type];

  document.getElementById('rIcon').textContent = cfg.icon;
  document.getElementById('rIcon').style.background = cfg.iconBg;
  document.getElementById('rTitle').textContent = cfg.title;
  document.getElementById('rSub').textContent   = cfg.sub;
  document.getElementById('rSummary').innerHTML = '';
  document.getElementById('rTableBody').innerHTML = `<tr><td colspan="${cfg.cols.length}" class="empty-state">
    <div class="empty-icon">ğŸ“Š</div>
    <div class="empty-text">Haz clic en "Generar" para cargar el reporte</div>
  </td></tr>`;

  // Set headers
  document.getElementById('rTableHead').innerHTML = `<tr>${cfg.cols.map(c => `<th>${c}</th>`).join('')}</tr>`;

  // Date range visibility
  const today = todayISO();
  document.getElementById('rDateFrom').value = today;
  document.getElementById('rDateTo').value   = today;

  document.getElementById('reportModal').classList.add('open');

  // Auto-load for non-inventory reports
  if (!cfg.showDateRange) loadReport();
}

function closeReport() {
  document.getElementById('reportModal').classList.remove('open');
}

// â”€â”€ Load report data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadReport() {
  const cfg = REPORT_CONFIG[currentReportType];
  if (!cfg) return;

  const fromDate = document.getElementById('rDateFrom').value || todayISO();
  const toDate   = document.getElementById('rDateTo').value   || todayISO();
  const from = new Date(fromDate).toISOString();
  const to   = new Date(toDate + 'T23:59:59').toISOString();

  const body = document.getElementById('rTableBody');
  body.innerHTML = `<tr><td colspan="${cfg.cols.length}" style="text-align:center;padding:20px;color:var(--text-300);">â³ Generando reporte...</td></tr>`;

  try {
    if (currentReportType === 'entradas') {
      let q = Q.from('inventario')
        .select('*, clientes(nombre), almacenes(nombre), usuarios!operador_id(nombre,nombre_display)')
        .gte('created_at', from).lte('created_at', to).order('created_at', { ascending: false });
      if (USER.cliente_id) q = q.eq('cliente_id', USER.cliente_id);
      const data = await safeQuery(() => q);
      currentReportData = (data||[]).map(r => ({
        sku: r.sku, numero_parte: r.numero_parte, descripcion: r.descripcion,
        cantidad: r.cantidad, bultos: r.bultos, tracking_number: r.tracking_number,
        cliente: r.clientes?.nombre, almacen: r.almacenes?.nombre,
        operador: r.usuarios?.nombre_display || r.usuarios?.nombre,
        fecha_entrada: fmtDateTime(r.fecha_entrada || r.created_at),
      }));

    } else if (currentReportType === 'salidas') {
      const data = await safeQuery(() =>
        Q.from('orden_items')
          .select('*, ordenes!orden_id(folio,transporte,sello,numero_orden,usuarios!operador_id(nombre,nombre_display))')
          .eq('confirmado', true)
          .gte('confirmado_at', from).lte('confirmado_at', to)
          .order('confirmado_at', { ascending: false })
      );
      currentReportData = (data||[]).map(r => ({
        sku: r.sku, descripcion: r.descripcion, cantidad: r.cantidad,
        folio_orden: r.ordenes?.folio, transporte: r.ordenes?.transporte,
        sello: r.ordenes?.sello,
        operador: r.ordenes?.usuarios?.nombre_display || r.ordenes?.usuarios?.nombre,
        confirmado_at: fmtDateTime(r.confirmado_at),
      }));

    } else if (currentReportType === 'inventario') {
      let q = Q.from('inventario')
        .select('*, clientes(nombre), almacenes(nombre)')
        .gte('fecha_entrada', fromDate).lte('fecha_entrada', toDate)
        .order('created_at', { ascending: false });
      if (USER.cliente_id) q = q.eq('cliente_id', USER.cliente_id);
      const data = await safeQuery(() => q);
      currentReportData = (data||[]).map(r => ({
        sku: r.sku, numero_parte: r.numero_parte, descripcion: r.descripcion,
        cantidad: r.cantidad, bultos: r.bultos, peso: r.peso,
        tracking_number: r.tracking_number, po: r.po, vendor: r.vendor, origin: r.origin,
        cliente: r.clientes?.nombre, almacen: r.almacenes?.nombre,
        ubicacion: r.ubicacion || r.zona, estado: r.estado,
        fecha_entrada: fmtDate(r.fecha_entrada || r.created_at),
      }));

    } else if (currentReportType === 'paqueteria') {
      let q = Q.from('paqueteria')
        .select('*, clientes(nombre), usuarios!operador_id(nombre,nombre_display)')
        .gte('created_at', from).lte('created_at', to)
        .order('created_at', { ascending: false });
      if (USER.cliente_id) q = q.eq('cliente_id', USER.cliente_id);
      const data = await safeQuery(() => q);
      currentReportData = (data||[]).map(r => ({
        codigo: r.codigo, carrier: r.carrier, tracking_number: r.tracking_number,
        bultos: r.bultos, cliente: r.clientes?.nombre, estado: r.estado,
        operador: r.usuarios?.nombre_display || r.usuarios?.nombre,
        created_at: fmtDateTime(r.created_at),
      }));
    }

    renderReportTable();
    renderSummary();

  } catch(e) {
    body.innerHTML = `<tr><td colspan="${cfg.cols.length}" style="text-align:center;padding:20px;color:var(--danger);">Error: ${e.message}</td></tr>`;
  }
}

function renderSummary() {
  const cfg = REPORT_CONFIG[currentReportType];
  const summary = document.getElementById('rSummary');
  summary.innerHTML = `
    <div style="background:var(--surface2);border-radius:10px;padding:12px 16px;border:1px solid var(--border);">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);">Total Registros</div>
      <div style="font-family:'Exo 2',sans-serif;font-size:28px;font-weight:900;color:var(--navy);">${currentReportData.length}</div>
    </div>`;
}

function renderReportTable() {
  const cfg = REPORT_CONFIG[currentReportType];
  const body = document.getElementById('rTableBody');
  if (!currentReportData.length) {
    body.innerHTML = `<tr><td colspan="${cfg.cols.length}" class="empty-state">
      <div class="empty-icon">ğŸ“­</div>
      <div class="empty-text">Sin registros en el perÃ­odo seleccionado</div>
    </td></tr>`;
    return;
  }
  body.innerHTML = currentReportData.map(row =>
    `<tr>${cfg.keys.map(k => `<td style="font-size:12px;">${row[k] || 'â€”'}</td>`).join('')}</tr>`
  ).join('');
}

// â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFmt(fmt, el) {
  currentFmt = fmt;
  document.querySelectorAll('.fmt-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function downloadReport() {
  if (!currentReportData.length) { showToast('Genera el reporte primero', 'warning'); return; }
  const cfg = REPORT_CONFIG[currentReportType];
  const from = document.getElementById('rDateFrom').value;
  const to   = document.getElementById('rDateTo').value;
  const filename = `${currentReportType}_${from}_${to}`;

  if (currentFmt === 'csv') {
    const cfg2 = REPORT_CONFIG[currentReportType];
    let csv = cfg2.cols.join(',') + '\n';
    currentReportData.forEach(r => {
      csv += cfg2.keys.map(k => `"${(r[k]||'').toString().replace(/"/g,'""')}"`).join(',') + '\n';
    });
    const blob = new Blob([csv], { type:'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename + '.csv';
    a.click();
    return;
  }

  if (currentFmt === 'pdf') {
    // Print as PDF
    const printWin = window.open('', '_blank');
    const cfg2 = REPORT_CONFIG[currentReportType];
    printWin.document.write(`<html><head><title>${cfg2.title}</title>
      <style>
        body{font-family:Arial,sans-serif;padding:20px;font-size:11px;}
        h2{font-size:16px;margin-bottom:4px;}
        .sub{color:#666;margin-bottom:14px;}
        table{width:100%;border-collapse:collapse;}
        th{background:#0d2b7a;color:white;padding:6px 8px;text-align:left;font-size:9px;letter-spacing:0.5px;}
        td{padding:5px 8px;border-bottom:1px solid #eee;}
        tr:nth-child(even) td{background:#f8f9ff;}
        @media print{body{padding:10px} @page{margin:10mm}}
      </style></head><body>
      <h2>${cfg2.title}</h2>
      <div class="sub">Total: ${currentReportData.length} registros Â· Generado: ${fmtDate(new Date().toISOString())}</div>
      <table>
        <thead><tr>${cfg2.cols.map(c=>`<th>${c}</th>`).join('')}</tr></thead>
        <tbody>${currentReportData.map(r=>`<tr>${cfg2.keys.map(k=>`<td>${r[k]||'â€”'}</td>`).join('')}</tr>`).join('')}</tbody>
      </table>
      </body></html>`);
    printWin.document.close();
    setTimeout(() => { printWin.print(); printWin.close(); }, 400);
    return;
  }

  // Default: XLSX
  exportXLSX(currentReportData, filename);
  showToast('ğŸ“¥ Descargando reporte...', 'success');
}

function printReport() {
  const cfg = REPORT_CONFIG[currentReportType];
  const el = document.getElementById('rTable');
  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>${cfg?.title||'Reporte'}</title>
    <style>
      body{font-family:Arial,sans-serif;padding:16px;font-size:11px;}
      table{width:100%;border-collapse:collapse;}
      th{background:#0d2b7a;color:white;padding:5px 8px;font-size:9px;}
      td{padding:4px 8px;border:1px solid #eee;}
      @media print{@page{margin:8mm}}
    </style></head><body onload="window.print()">
    ${el.outerHTML}
    </body></html>`);
  w.document.close();
}
</script>
</body>
</html>
