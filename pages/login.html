<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IDEA SCAN 2.0 ‚Äî Iniciar Sesi√≥n</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>üì¶</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;800;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --navy: #0d2b7a; --navy-d: #081e5c;
  --cyan: #00c2ff; --border: #dde5f8;
  --surface: #f4f7ff; --text-900: #0d1b3e;
  --text-300: #94a8d0; --danger: #ef4444;
  --success: #22c77a;
}
html, body { height: 100%; font-family: 'Inter', sans-serif; }

/* ‚îÄ‚îÄ Background ‚îÄ‚îÄ */
.login-bg {
  min-height: 100vh;
  background: linear-gradient(135deg, var(--navy-d) 0%, var(--navy) 50%, #1a47a0 100%);
  display: flex; align-items: center; justify-content: center;
  padding: 20px;
  position: relative; overflow: hidden;
}
.login-bg::before {
  content: '';
  position: absolute; inset: 0;
  background:
    radial-gradient(circle at 20% 80%, rgba(0,194,255,.15) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(45,110,245,.2) 0%, transparent 50%);
}
.login-bg::after {
  content: '';
  position: absolute;
  width: 600px; height: 600px;
  border-radius: 50%;
  border: 1px solid rgba(0,194,255,.1);
  top: -200px; right: -200px;
  animation: rotate 20s linear infinite;
}
@keyframes rotate { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ Decorative floating boxes ‚îÄ‚îÄ */
.float-box {
  position: absolute;
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.03);
  animation: float 6s ease-in-out infinite;
}
.float-box:nth-child(1) { width:80px;height:80px; top:10%; left:8%; animation-delay:0s; }
.float-box:nth-child(2) { width:50px;height:50px; top:70%; left:5%; animation-delay:1.5s; }
.float-box:nth-child(3) { width:100px;height:60px; top:20%; right:6%; animation-delay:3s; }
.float-box:nth-child(4) { width:60px;height:60px; bottom:15%; right:10%; animation-delay:1s; }
@keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-15px)} }

/* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
.login-card {
  position: relative; z-index: 1;
  background: white;
  border-radius: 24px;
  width: 100%; max-width: 420px;
  box-shadow: 0 24px 80px rgba(0,0,0,.4), 0 0 0 1px rgba(255,255,255,.1);
  overflow: hidden;
  animation: slideUp .6s cubic-bezier(.34,1.3,.64,1) both;
}
@keyframes slideUp {
  from { opacity:0; transform:translateY(30px) scale(.97); }
  to   { opacity:1; transform:translateY(0) scale(1); }
}

/* ‚îÄ‚îÄ Card header ‚îÄ‚îÄ */
.login-header {
  background: linear-gradient(135deg, var(--navy-d) 0%, var(--navy) 60%, #1a47a0 100%);
  padding: 36px 32px 32px;
  text-align: center;
  position: relative;
}
.login-header::after {
  content: '';
  position: absolute; bottom: -1px; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
}
.login-logo-wrap {
  width: 72px; height: 72px;
  background: rgba(255,255,255,.1);
  border: 2px solid rgba(0,194,255,.35);
  border-radius: 20px;
  display: flex; align-items: center; justify-content: center;
  font-size: 36px;
  margin: 0 auto 16px;
  box-shadow: 0 0 40px rgba(0,194,255,.25), inset 0 0 20px rgba(0,194,255,.1);
  animation: pulse 3s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{box-shadow:0 0 40px rgba(0,194,255,.25)} 50%{box-shadow:0 0 60px rgba(0,194,255,.45)} }
.login-app-name {
  font-family: 'Exo 2', sans-serif;
  font-size: 28px; font-weight: 900;
  color: white; letter-spacing: 1px;
  text-shadow: 0 2px 12px rgba(0,0,0,.3);
  margin-bottom: 2px;
}
.login-app-name span { color: var(--cyan); }
.login-company {
  font-size: 11px; font-weight: 600;
  color: rgba(255,255,255,.45);
  letter-spacing: 3px; text-transform: uppercase;
}

/* ‚îÄ‚îÄ Card body ‚îÄ‚îÄ */
.login-body { padding: 32px; }

.login-tagline {
  font-size: 14px; color: #5870a8;
  margin-bottom: 24px; text-align: center;
  font-weight: 500;
}

.form-group { margin-bottom: 18px; }
.form-label {
  display: block; font-size: 11px; font-weight: 700;
  text-transform: uppercase; letter-spacing: .8px;
  color: #5870a8; margin-bottom: 6px;
}
.form-input-wrap { position: relative; }
.form-input-icon {
  position: absolute; left: 13px; top: 50%;
  transform: translateY(-50%); font-size: 16px; pointer-events: none;
}
.form-input {
  width: 100%; padding: 11px 14px 11px 40px;
  border: 1.5px solid var(--border);
  border-radius: 10px;
  font-family: 'Inter', sans-serif;
  font-size: 14px; color: var(--text-900);
  background: var(--surface); outline: none;
  transition: all .2s;
}
.form-input:focus { border-color: var(--cyan); background: white; box-shadow: 0 0 0 3px rgba(0,194,255,.1); }
.form-input.error { border-color: var(--danger); }
.input-toggle {
  position: absolute; right: 12px; top: 50%;
  transform: translateY(-50%); cursor: pointer;
  font-size: 16px; color: var(--text-300);
  background: none; border: none; padding: 0;
}

.login-btn {
  width: 100%; padding: 13px;
  background: linear-gradient(135deg, var(--navy), #2d6ef5);
  color: white; border: none;
  border-radius: 10px;
  font-family: 'Exo 2', sans-serif;
  font-size: 15px; font-weight: 800;
  cursor: pointer; transition: all .2s;
  box-shadow: 0 4px 20px rgba(13,43,122,.35);
  display: flex; align-items: center; justify-content: center; gap: 8px;
  margin-top: 8px;
}
.login-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 28px rgba(13,43,122,.45); }
.login-btn:active { transform: translateY(0); }
.login-btn:disabled { opacity: .6; cursor: not-allowed; transform: none; }

.error-msg {
  background: rgba(239,68,68,.08); border: 1px solid rgba(239,68,68,.2);
  color: #dc2626; border-radius: 8px;
  padding: 10px 14px; font-size: 12px; font-weight: 500;
  margin-bottom: 16px; display: none; align-items: center; gap: 6px;
}
.error-msg.show { display: flex; }

.login-footer {
  text-align: center; margin-top: 20px;
  font-size: 11px; color: var(--text-300);
}

/* Loading spinner */
.spinner {
  width: 18px; height: 18px; border-radius: 50%;
  border: 2px solid rgba(255,255,255,.3);
  border-top-color: white;
  animation: spin .7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
@media (max-width: 480px) {
  .login-header { padding: 28px 24px 26px; }
  .login-body { padding: 24px; }
  .login-app-name { font-size: 24px; }
  .login-logo-wrap { width: 60px; height: 60px; font-size: 28px; }
  .float-box { display: none; }
}
</style>
</head>
<body>

<div class="login-bg">
  <div class="float-box"></div>
  <div class="float-box"></div>
  <div class="float-box"></div>
  <div class="float-box"></div>

  <div class="login-card">
    <!-- Header -->
    <div class="login-header">
      <div class="login-logo-wrap">üì¶</div>
      <div class="login-app-name">IDEA <span>SCAN</span> 2.0</div>
      <div class="login-company">CCA Group</div>
    </div>

    <!-- Body -->
    <div class="login-body">
      <div class="login-tagline">Warehouse Management System</div>

      <div class="error-msg" id="errMsg">
        <span>‚ö†Ô∏è</span> <span id="errText">Usuario o contrase√±a incorrectos</span>
      </div>

      <div class="form-group">
        <label class="form-label">Usuario</label>
        <div class="form-input-wrap">
          <span class="form-input-icon">üë§</span>
          <input type="text" class="form-input" id="username"
            placeholder="Ingresa tu usuario" autocomplete="username"
            onkeydown="if(event.key==='Enter')document.getElementById('password').focus()">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Contrase√±a</label>
        <div class="form-input-wrap">
          <span class="form-input-icon">üîí</span>
          <input type="password" class="form-input" id="password"
            placeholder="Ingresa tu contrase√±a" autocomplete="current-password"
            onkeydown="if(event.key==='Enter')doLogin()">
          <button class="input-toggle" id="togglePwd" onclick="togglePassword()">üëÅ</button>
        </div>
      </div>

      <button class="login-btn" id="loginBtn" onclick="doLogin()">
        <span id="loginBtnText">Iniciar Sesi√≥n</span>
      </button>

      <div class="login-footer">
        Sistema de gesti√≥n de almac√©n ‚Äî Acceso restringido
      </div>
    </div>
  </div>
</div>

<script>
const SUPA_URL = 'https://usqugtxeynkozlobeojt.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVzcXVndHhleW5rb3psb2Jlb2p0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwOTYxMzAsImV4cCI6MjA4NjY3MjEzMH0.zs4XiF8AgcE-l3ebtaxvoN7V9rf-6MHWNxMThiQUXKE';
const SESSION_KEY = 'ideascan_session';

const db = supabase.createClient(SUPA_URL, SUPA_KEY);

// Check if already logged in
window.addEventListener('DOMContentLoaded', () => {
  try {
    const s = sessionStorage.getItem(SESSION_KEY) || localStorage.getItem(SESSION_KEY);
    if (s && JSON.parse(s)?.id) location.href = 'inventario.html';
  } catch {}
  document.getElementById('username').focus();
});

function togglePassword() {
  const inp = document.getElementById('password');
  const btn = document.getElementById('togglePwd');
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'üôà'; }
  else { inp.type = 'password'; btn.textContent = 'üëÅ'; }
}

function setError(msg) {
  const el = document.getElementById('errMsg');
  document.getElementById('errText').textContent = msg;
  el.classList.add('show');
}
function clearError() { document.getElementById('errMsg').classList.remove('show'); }

async function doLogin() {
  clearError();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  if (!username || !password) { setError('Ingresa tu usuario y contrase√±a'); return; }

  const btn = document.getElementById('loginBtn');
  const txt = document.getElementById('loginBtnText');
  btn.disabled = true;
  txt.innerHTML = '<div class="spinner"></div> Verificando...';

  try {
    // 1. Get user record + cliente codigo in one query
    const { data: users, error } = await db.schema('ideascan')
      .from('usuarios')
      .select('*, clientes(codigo, nombre)')
      .eq('username', username)
      .eq('estado', 'active')
      .limit(1);

    if (error || !users?.length) {
      setError('Usuario no encontrado o inactivo');
      return;
    }

    const user = users[0];
    const clienteCodigo = user.clientes?.codigo || '';
    const clienteNombre = user.clientes?.nombre || '';
    let authenticated = false;

    // 2a. Try Supabase Auth with internal email
    const internalEmail = `${username}@ideascan.wms`;
    const { error: authErr1 } = await db.auth.signInWithPassword({ email: internalEmail, password });
    if (!authErr1) { authenticated = true; }

    // 2b. Try with actual email if different
    if (!authenticated && user.email && user.email !== internalEmail) {
      const { error: authErr2 } = await db.auth.signInWithPassword({ email: user.email, password });
      if (!authErr2) { authenticated = true; }
    }

    // 2c. Fallback: plain-text password_hash check (for dev/initial setup)
    if (!authenticated && user.password_hash) {
      if (user.password_hash === password) { authenticated = true; }
    }

    if (!authenticated) {
      setError('Contrase√±a incorrecta');
      return;
    }

    // 3. Build session object
    const session = {
      id:             user.id,
      username:       user.username,
      nombre:         user.nombre_display || user.nombre || user.username,
      rol:            user.rol,
      cliente_id:     user.cliente_id,
      cliente_codigo: clienteCodigo.toUpperCase(),   // 'SAFRAN' | 'MARTECH' | ''
      cliente_nombre: clienteNombre,
      almacen_id:     user.almacen_id,
      color:          user.color || '#0d2b7a',
      email:          user.email,
    };

    sessionStorage.setItem(SESSION_KEY, JSON.stringify(session));

    // 4. Update last access
    await db.schema('ideascan').from('usuarios')
      .update({ ultimo_acceso: new Date().toISOString() })
      .eq('id', user.id);

    // 5. Redirect
    location.href = 'inventario.html';

  } catch(e) {
    console.error(e);
    setError('Error de conexi√≥n. Verifica tu internet.');
  } finally {
    btn.disabled = false;
    txt.textContent = 'Iniciar Sesi√≥n';
  }
}
</script>
</body>
</html>
