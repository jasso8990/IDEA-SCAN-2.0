<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IDEA SCAN 2.0 â€” Mapa de AlmacÃ©n</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>ğŸ—ºï¸</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;800;900&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link rel="stylesheet" href="../css/app.css">
<style>
/* â”€â”€ Map canvas â”€â”€ */
.map-toolbar {
  display: flex; align-items: center; gap: 8px;
  flex-wrap: wrap; margin-bottom: 14px;
}
.map-container {
  background: #f0f4ff;
  border: 2px solid var(--border);
  border-radius: 14px; overflow: hidden;
  position: relative; min-height: 520px;
  box-shadow: var(--shadow);
  cursor: crosshair;
}
.map-grid {
  position: absolute; inset: 0; pointer-events: none;
  background-image:
    linear-gradient(rgba(13,43,122,.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(13,43,122,.04) 1px, transparent 1px);
  background-size: 40px 40px;
}

/* Zone blocks */
.zone-block {
  position: absolute;
  border-radius: 8px;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  cursor: move;
  font-family: 'Exo 2', sans-serif;
  font-size: 11px; font-weight: 800;
  text-align: center; padding: 4px;
  border: 2px solid rgba(0,0,0,.15);
  box-shadow: 0 2px 8px rgba(0,0,0,.12);
  transition: box-shadow .15s;
  user-select: none; overflow: hidden;
  min-width: 80px; min-height: 60px;
}
.zone-block:hover { box-shadow: 0 4px 16px rgba(0,0,0,.2); }
.zone-block.selected { outline: 3px solid var(--navy); outline-offset: 2px; }
.zone-block .zone-icon { font-size: 18px; line-height: 1; margin-bottom: 2px; }
.zone-block .zone-name { line-height: 1.1; word-break: break-word; }
.zone-block .zone-occ {
  font-size: 9px; font-weight: 600; opacity: .8; margin-top: 2px;
}
.zone-block .zone-del {
  position: absolute; top:3px; right:3px;
  width:16px; height:16px; border-radius:50%;
  background: rgba(0,0,0,.25); border:none; color:white;
  font-size:9px; cursor:pointer; display:none;
  align-items:center; justify-content:center;
}
.zone-block:hover .zone-del { display:flex; }

/* Resize handle */
.zone-block .resize-handle {
  position: absolute; bottom:3px; right:3px;
  width:10px; height:10px; cursor:se-resize;
  border-right:2px solid rgba(0,0,0,.3);
  border-bottom:2px solid rgba(0,0,0,.3);
  display: none;
}
.zone-block.selected .resize-handle { display:block; }

/* Zone legend */
.zone-legend { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
.legend-item { display:flex; align-items:center; gap:6px; font-size:11px; font-weight:600; color:var(--text-700); }
.legend-dot { width:12px; height:12px; border-radius:3px; flex-shrink:0; }

/* Warehouse selector */
.warehouse-sel {
  background: white; border: 1.5px solid var(--border);
  border-radius: 10px; padding: 7px 12px; font-size:13px;
  color:var(--navy); font-weight:600; outline:none; cursor:pointer;
}
.warehouse-sel:focus { border-color:var(--cyan); }

/* Mini palette */
.zone-palette {
  display: flex; gap: 6px; flex-wrap: wrap;
  background: white; border: 1px solid var(--border);
  border-radius: 10px; padding: 8px 12px;
  margin-bottom: 14px;
}
.palette-zone {
  display:flex; align-items:center; gap:5px;
  padding:5px 10px; border-radius:7px; cursor:pointer;
  border:1.5px solid transparent; font-size:11px; font-weight:700;
  transition:all .18s;
}
.palette-zone:hover { transform:translateY(-1px); box-shadow:var(--shadow); }
</style>
</head>
<body>
<div class="app-shell">
  <nav class="sidebar" id="sidebar"></nav>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="main-content">
    <div class="top-header">
      <button class="hamburger" onclick="toggleSidebar()"><span></span></button>
      <div class="header-title">Mapa <span>de AlmacÃ©n</span></div>
      <div class="header-actions">
        <select class="warehouse-sel" id="warehouseSel" onchange="loadWarehouseMap()"></select>
        <button class="header-btn" id="editBtn" onclick="toggleEdit()" title="Editar mapa">âœï¸</button>
        <button class="header-btn" onclick="printMap()" title="Imprimir">ğŸ–¨ï¸</button>
      </div>
    </div>

    <div class="page-body">
      <!-- Zone type palette (only in edit mode) -->
      <div id="palette" style="display:none;">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);margin-bottom:6px;">Agregar zona â€” clic en el tipo y luego clic en el mapa</div>
        <div class="zone-palette" id="zonePalette"></div>
      </div>

      <!-- Map toolbar -->
      <div class="map-toolbar">
        <div id="editHint" style="font-size:11px;color:var(--text-300);"></div>
        <div style="flex:1;"></div>
        <button class="btn btn-ghost btn-sm" id="saveMapBtn" style="display:none;" onclick="saveMap()">ğŸ’¾ Guardar mapa</button>
      </div>

      <!-- Map canvas -->
      <div class="map-container" id="mapContainer" onclick="handleMapClick(event)">
        <div class="map-grid"></div>
        <div id="zonesLayer"></div>
        <div id="mapEmpty" style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;min-height:520px;color:var(--text-300);">
          <div style="font-size:48px;margin-bottom:12px;">ğŸ—ºï¸</div>
          <div style="font-size:14px;font-weight:600;color:var(--text-500);">Selecciona un almacÃ©n para ver su mapa</div>
        </div>
      </div>

      <!-- Zone legend -->
      <div class="zone-legend" id="zoneLegend"></div>
    </div>
  </div>
</div>

<!-- â•â• MODAL: Zone edit â•â• -->
<div class="modal-overlay" id="zoneModal" onclick="if(event.target===this)closeZoneModal()">
  <div class="modal" style="max-width:380px;">
    <div class="modal-header">
      <div class="modal-icon" id="zmIcon" style="font-size:22px;background:rgba(13,43,122,.08)">ğŸ“¦</div>
      <div>
        <div class="modal-title" id="zmTitle">Nueva Zona</div>
        <div class="modal-sub">Configura la zona del almacÃ©n</div>
      </div>
      <button class="modal-close" onclick="closeZoneModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nombre de la zona <span class="req">*</span></label>
        <input class="form-input" id="zmNombre" placeholder="Ej. Zona A-01">
      </div>
      <div class="form-group">
        <label class="form-label">CÃ³digo</label>
        <input class="form-input mono" id="zmCodigo" placeholder="Ej. ZA01" oninput="this.value=this.value.toUpperCase()">
      </div>
      <div class="form-group">
        <label class="form-label">Tipo</label>
        <select class="form-select" id="zmTipo">
          <option value="almacenaje">ğŸ“¦ Almacenaje</option>
          <option value="recepcion">ğŸ“¥ RecepciÃ³n</option>
          <option value="despacho">ğŸ“¤ Despacho</option>
          <option value="cross_dock">ğŸ”„ Cross Dock</option>
          <option value="refrigerado">â„ï¸ Refrigerado</option>
          <option value="restringido">ğŸ”’ Restringido</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Capacidad</label>
        <input class="form-input" id="zmCap" type="number" placeholder="100">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeZoneModal()">Cancelar</button>
      <button class="btn btn-primary btn-sm" onclick="saveZone()">Guardar Zona</button>
    </div>
  </div>
</div>

<div class="bottom-nav" id="bottomNav"></div>
<div class="toast" id="globalToast"></div>

<script src="../js/core.js"></script>
<script>
// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let USER;
let isEditMode    = false;
let currentWHid   = null;
let zones         = [];       // [{id,nombre,codigo,tipo,pos_x,pos_y,ancho,alto,color,ocupacion,capacidad}]
let pendingType   = null;     // type to place on next click
let dragging      = null;     // {el, zoneIdx, offX, offY}
let resizing      = null;
let editingZoneIdx = null;
let pendingZonePos = null;    // {x,y} for new zone placement

const ZONE_TYPES = {
  almacenaje: { icon:'ğŸ“¦', color:'#3b82f6', label:'Almacenaje' },
  recepcion:  { icon:'ğŸ“¥', color:'#22c77a', label:'RecepciÃ³n' },
  despacho:   { icon:'ğŸ“¤', color:'#ef4444', label:'Despacho' },
  cross_dock: { icon:'ğŸ”„', color:'#f59e0b', label:'Cross Dock' },
  refrigerado:{ icon:'â„ï¸', color:'#00c2ff', label:'Refrigerado' },
  restringido:{ icon:'ğŸ”’', color:'#8b5cf6', label:'Restringido' },
};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  USER = initPage('mapa', ['admin','supervisor','operador']);
  if (!USER) return;
  await loadWarehouses();
  renderPalette();
});

async function loadWarehouses() {
  let q = Q.from('almacenes').select('id,nombre').eq('activo', true).order('nombre');
  if (USER.almacen_id) q = q.eq('id', USER.almacen_id);
  const data = await safeQuery(() => q);
  const sel = document.getElementById('warehouseSel');
  sel.innerHTML = '<option value="">â€” Seleccionar almacÃ©n â€”</option>' +
    (data||[]).map(a => `<option value="${a.id}">${a.nombre}</option>`).join('');
  if (data?.length === 1) { sel.value = data[0].id; loadWarehouseMap(); }
}

async function loadWarehouseMap() {
  currentWHid = document.getElementById('warehouseSel').value;
  if (!currentWHid) return;

  const data = await safeQuery(() =>
    Q.from('zonas').select('*').eq('almacen_id', currentWHid).eq('activo', true)
  );
  zones = data || [];
  renderZones();
  renderLegend();
  document.getElementById('mapEmpty').style.display = zones.length ? 'none' : 'flex';
}

// â”€â”€ Render zones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderZones() {
  const layer = document.getElementById('zonesLayer');
  layer.innerHTML = '';
  zones.forEach((z, idx) => {
    const zt = ZONE_TYPES[z.tipo] || ZONE_TYPES.almacenaje;
    const occ = z.capacidad > 0 ? Math.round((z.ocupacion||0)/z.capacidad*100) : 0;
    const div = document.createElement('div');
    div.className = 'zone-block';
    div.dataset.idx = idx;
    div.style.cssText = `
      left:${z.pos_x}px; top:${z.pos_y}px;
      width:${z.ancho||120}px; height:${z.alto||80}px;
      background:${zt.color}22; color:${zt.color};
      border-color:${zt.color}66;`;
    div.innerHTML = `
      <button class="zone-del" onclick="deleteZone(${idx})">âœ•</button>
      <div class="zone-icon">${zt.icon}</div>
      <div class="zone-name">${z.nombre}</div>
      ${z.capacidad > 0 ? `<div class="zone-occ">${occ}% ocupado</div>` : ''}
      <div class="resize-handle"></div>`;
    div.addEventListener('mousedown', e => onZoneMouseDown(e, idx));
    div.addEventListener('dblclick', () => editZone(idx));
    layer.appendChild(div);
  });
}

function renderLegend() {
  const usedTypes = [...new Set(zones.map(z => z.tipo))];
  document.getElementById('zoneLegend').innerHTML = usedTypes.map(t => {
    const zt = ZONE_TYPES[t] || ZONE_TYPES.almacenaje;
    return `<div class="legend-item">
      <div class="legend-dot" style="background:${zt.color}"></div>
      ${zt.label}
    </div>`;
  }).join('');
}

function renderPalette() {
  document.getElementById('zonePalette').innerHTML = Object.entries(ZONE_TYPES).map(([k,v]) =>
    `<div class="palette-zone" style="background:${v.color}18;border-color:${v.color}44;color:${v.color};"
      id="pal_${k}" onclick="selectPaletteType('${k}')">
      ${v.icon} ${v.label}
    </div>`).join('');
}

function selectPaletteType(type) {
  pendingType = type;
  document.querySelectorAll('.palette-zone').forEach(el => el.style.outline = 'none');
  const zt = ZONE_TYPES[type];
  document.getElementById('pal_'+type).style.outline = `2px solid ${zt.color}`;
  document.getElementById('mapContainer').style.cursor = 'crosshair';
  document.getElementById('editHint').textContent = `Haz clic en el mapa para colocar zona: ${zt.label}`;
}

// â”€â”€ Map click: place zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMapClick(e) {
  if (!isEditMode || !pendingType) return;
  if (e.target.closest('.zone-block')) return;
  const rect = document.getElementById('mapContainer').getBoundingClientRect();
  const x = Math.round((e.clientX - rect.left) / 40) * 40;
  const y = Math.round((e.clientY - rect.top)  / 40) * 40;
  pendingZonePos = { x: Math.max(0,x), y: Math.max(0,y) };
  openZoneModal();
}

// â”€â”€ Zone modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openZoneModal(editIdx = null) {
  editingZoneIdx = editIdx;
  if (editIdx !== null) {
    const z = zones[editIdx];
    document.getElementById('zmTitle').textContent = `Editar: ${z.nombre}`;
    document.getElementById('zmNombre').value = z.nombre;
    document.getElementById('zmCodigo').value = z.codigo || '';
    document.getElementById('zmTipo').value   = z.tipo   || 'almacenaje';
    document.getElementById('zmCap').value    = z.capacidad || '';
    document.getElementById('zmIcon').textContent = ZONE_TYPES[z.tipo]?.icon || 'ğŸ“¦';
  } else {
    document.getElementById('zmTitle').textContent = 'Nueva Zona';
    document.getElementById('zmNombre').value = '';
    document.getElementById('zmCodigo').value = '';
    document.getElementById('zmTipo').value   = pendingType || 'almacenaje';
    document.getElementById('zmCap').value    = '';
    document.getElementById('zmIcon').textContent = ZONE_TYPES[pendingType]?.icon || 'ğŸ“¦';
  }
  document.getElementById('zoneModal').classList.add('open');
}
function closeZoneModal() { document.getElementById('zoneModal').classList.remove('open'); }
function editZone(idx) { if (isEditMode) openZoneModal(idx); }

function saveZone() {
  const nombre = document.getElementById('zmNombre').value.trim();
  if (!nombre) { showToast('Ingresa un nombre para la zona', 'warning'); return; }

  const tipo = document.getElementById('zmTipo').value;
  const zt   = ZONE_TYPES[tipo];

  if (editingZoneIdx !== null) {
    zones[editingZoneIdx] = {
      ...zones[editingZoneIdx],
      nombre,
      codigo:    document.getElementById('zmCodigo').value.trim().toUpperCase(),
      tipo,
      color:     zt.color,
      capacidad: parseInt(document.getElementById('zmCap').value)||0,
    };
  } else if (pendingZonePos) {
    zones.push({
      id: null, almacen_id: currentWHid,
      nombre,
      codigo:    document.getElementById('zmCodigo').value.trim().toUpperCase(),
      tipo,      color: zt.color,
      pos_x:     pendingZonePos.x, pos_y: pendingZonePos.y,
      ancho: 120, alto: 80,
      capacidad: parseInt(document.getElementById('zmCap').value)||0,
      ocupacion: 0, activo: true,
    });
    pendingZonePos = null;
  }

  closeZoneModal();
  pendingType = null;
  document.querySelectorAll('.palette-zone').forEach(el => el.style.outline = 'none');
  document.getElementById('mapContainer').style.cursor = 'crosshair';
  document.getElementById('editHint').textContent = 'Selecciona un tipo de zona para agregar';
  renderZones();
  renderLegend();
  document.getElementById('mapEmpty').style.display = zones.length ? 'none' : 'flex';
}

function deleteZone(idx) {
  if (!confirm('Â¿Eliminar esta zona?')) return;
  zones[idx]._delete = true;
  zones.splice(idx, 1);
  renderZones();
  renderLegend();
}

// â”€â”€ Drag & resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onZoneMouseDown(e, idx) {
  if (!isEditMode) return;
  e.stopPropagation();
  const el = e.currentTarget;
  if (e.target.classList.contains('resize-handle')) {
    resizing = { el, idx, startW: zones[idx].ancho, startH: zones[idx].alto, startX: e.clientX, startY: e.clientY };
  } else {
    const rect = el.getBoundingClientRect();
    dragging = { el, idx, offX: e.clientX - rect.left, offY: e.clientY - rect.top };
    el.classList.add('selected');
  }
}

document.addEventListener('mousemove', e => {
  if (dragging) {
    const container = document.getElementById('mapContainer').getBoundingClientRect();
    let x = Math.round((e.clientX - container.left - dragging.offX) / 40) * 40;
    let y = Math.round((e.clientY - container.top  - dragging.offY) / 40) * 40;
    x = Math.max(0, Math.min(x, container.width  - (zones[dragging.idx]?.ancho||120)));
    y = Math.max(0, Math.min(y, container.height - (zones[dragging.idx]?.alto ||80)));
    zones[dragging.idx].pos_x = Math.round(x);
    zones[dragging.idx].pos_y = Math.round(y);
    dragging.el.style.left = x + 'px';
    dragging.el.style.top  = y + 'px';
  }
  if (resizing) {
    const dw = e.clientX - resizing.startX;
    const dh = e.clientY - resizing.startY;
    const w = Math.max(80, Math.round((resizing.startW + dw) / 40) * 40);
    const h = Math.max(60, Math.round((resizing.startH + dh) / 40) * 40);
    zones[resizing.idx].ancho = Math.round(w);
    zones[resizing.idx].alto  = Math.round(h);
    resizing.el.style.width  = w + 'px';
    resizing.el.style.height = h + 'px';
  }
});

document.addEventListener('mouseup', () => {
  if (dragging) { dragging.el.classList.remove('selected'); dragging = null; }
  if (resizing) { resizing = null; }
});

// â”€â”€ Edit mode toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleEdit() {
  const canEdit = USER.rol === 'admin' ||
    (USER.rol === 'supervisor' && USER.almacen_id === currentWHid) ||
    (USER.rol === 'operador'   && USER.almacen_id === currentWHid);

  if (!canEdit) { showToast('No tienes permisos para editar este mapa', 'warning'); return; }

  isEditMode = !isEditMode;
  const btn     = document.getElementById('editBtn');
  const palette = document.getElementById('palette');
  const saveBtn = document.getElementById('saveMapBtn');
  const cont    = document.getElementById('mapContainer');

  btn.style.background     = isEditMode ? 'rgba(0,194,255,.1)' : '';
  btn.style.borderColor    = isEditMode ? 'var(--cyan)' : '';
  palette.style.display    = isEditMode ? '' : 'none';
  saveBtn.style.display    = isEditMode ? '' : 'none';
  cont.style.cursor        = isEditMode ? 'crosshair' : 'default';

  // Toggle delete buttons
  document.querySelectorAll('.zone-del').forEach(el => {
    el.style.display = isEditMode ? '' : 'none';
  });

  if (isEditMode) {
    document.getElementById('editHint').textContent = 'Modo ediciÃ³n activo â€” selecciona un tipo de zona para agregar';
    showToast('âœï¸ Modo ediciÃ³n activado', 'info');
  } else {
    pendingType = null;
    document.getElementById('editHint').textContent = '';
    showToast('Vista guardada temporalmente', 'info');
  }
}

// â”€â”€ Save map to Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveMap() {
  if (!currentWHid) return;
  const btn = document.getElementById('saveMapBtn');
  btn.disabled = true; btn.textContent = 'â³ Guardando...';

  try {
    // Delete existing zones for this warehouse
    await Q.from('zonas').update({ activo: false }).eq('almacen_id', currentWHid);

    // Upsert all current zones
    const toSave = zones.map(z => ({
      ...(z.id ? { id: z.id } : {}),
      almacen_id: currentWHid,
      nombre:     z.nombre, codigo: z.codigo || z.nombre.slice(0,4).toUpperCase(),
      tipo:       z.tipo,   color:  ZONE_TYPES[z.tipo]?.color || '#3b82f6',
      pos_x:      Math.round(z.pos_x || 0),  pos_y: Math.round(z.pos_y || 0),
      ancho:      Math.round(z.ancho || 120),  alto:  Math.round(z.alto  || 80),
      capacidad:  z.capacidad || 0, ocupacion: z.ocupacion || 0,
      activo:     true,
    }));

    if (toSave.length) {
      const { error } = await Q.from('zonas').upsert(toSave, { onConflict: 'id' });
      if (error) throw error;
    }

    showToast('âœ… Mapa guardado correctamente', 'success');
    isEditMode = false;
    document.getElementById('editBtn').style.background = '';
    document.getElementById('editBtn').style.borderColor = '';
    document.getElementById('palette').style.display = 'none';
    btn.style.display = 'none';
    document.getElementById('editHint').textContent = '';
    document.getElementById('mapContainer').style.cursor = 'default';
    await loadWarehouseMap();
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'ğŸ’¾ Guardar mapa';
  }
}

// â”€â”€ Print map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function printMap() {
  const container = document.getElementById('mapContainer');
  const w = window.open('', '_blank');
  const almNombre = document.getElementById('warehouseSel').options[document.getElementById('warehouseSel').selectedIndex]?.text || 'AlmacÃ©n';
  w.document.write(`<html><head><title>Mapa ${almNombre}</title>
    <style>
      body{font-family:Arial,sans-serif;padding:20px;}
      h2{font-size:18px;margin-bottom:12px;}
      .map-container{background:#f0f4ff;border:2px solid #ccc;border-radius:12px;overflow:hidden;position:relative;min-height:520px;}
      @media print{@page{margin:10mm}}
    </style></head><body onload="window.print()">
    <h2>ğŸ—ºï¸ Mapa: ${almNombre}</h2>
    <div class="map-container">${container.innerHTML}</div>
    </body></html>`);
  w.document.close();
}
</script>
</body>
</html>
