<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IDEA SCAN 2.0 â€” Ã“rdenes</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>ğŸ“‹</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;800;900&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" href="../css/app.css">
<style>
/* â”€â”€ Order cards â”€â”€ */
.order-card {
  background: white; border-radius: 12px;
  border: 1px solid var(--border);
  padding: 14px 16px; margin-bottom: 10px;
  cursor: pointer; transition: all .2s;
  box-shadow: var(--shadow);
  display: flex; align-items: center; gap: 14px;
}
.order-card:hover { transform: translateY(-1px); box-shadow: var(--shadow-lg); border-color: var(--cyan); }
.order-type-icon {
  width: 42px; height: 42px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0;
}
.order-info { flex: 1; min-width: 0; }
.order-folio { font-family:'JetBrains Mono',monospace; font-size:13px; font-weight:800; color:var(--navy); }
.order-meta  { font-size:11px; color:var(--text-500); margin-top:2px; }
.order-status { flex-shrink: 0; }

/* â”€â”€ Progress bar â”€â”€ */
.progress-bar {
  height: 4px; border-radius: 2px; background: var(--border);
  margin-top: 8px; overflow: hidden;
}
.progress-fill { height: 100%; border-radius: 2px; transition: width .4s; }

/* â”€â”€ SKU scan list â”€â”€ */
.sku-scan-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 12px; border-radius: 9px; border: 1px solid var(--border);
  margin-bottom: 8px; cursor: pointer; transition: all .18s;
}
.sku-scan-item.selected { border-color: var(--cyan); background: rgba(0,194,255,.04); }
.sku-scan-item.confirmed { border-color: var(--success); background: rgba(34,199,122,.04); }
.sku-scan-item.error     { border-color: var(--danger); background: rgba(239,68,68,.04); }

/* â”€â”€ AI verification panel â”€â”€ */
.ai-panel {
  display: grid; grid-template-columns: 260px 1fr 200px;
  height: 100%; gap: 0;
}
@media (max-width: 900px) {
  .ai-panel { grid-template-columns: 1fr; grid-template-rows: auto 1fr auto; }
  .ai-sku-panel { max-height: 180px; overflow-y: auto; }
}
.ai-sku-panel {
  background: white; overflow-y: auto;
  border-right: 1px solid rgba(255,255,255,.1);
}
.ai-camera-panel {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 12px; padding: 18px; background: #080820;
}
.ai-result-panel {
  background: rgba(255,255,255,.05);
  overflow-y: auto;
  border-left: 1px solid rgba(255,255,255,.1);
}
</style>
</head>
<body>
<div class="app-shell">
  <nav class="sidebar" id="sidebar"></nav>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <div class="main-content">
    <div class="top-header">
      <button class="hamburger" onclick="toggleSidebar()"><span></span></button>
      <div class="header-title">Ã“rdenes <span>de Salida</span></div>
      <div class="header-actions">
        <button class="header-btn" id="newOrderBtn" onclick="openNewOrderModal()" title="Nueva orden">â•</button>
        <button class="header-btn" id="alertBtn" onclick="location.href='inventario.html'" title="Alertas">ğŸ””<span class="badge" id="pendingCount" style="display:none">0</span></button>
      </div>
    </div>

    <div class="page-body">
      <!-- KPIs -->
      <div class="kpi-grid">
        <div class="kpi-card inv">
          <div class="kpi-label">ğŸ“‹ Ã“rdenes del Mes</div>
          <div class="kpi-value" id="kpiMes">â€”</div>
          <div class="kpi-sub">Total del mes</div>
        </div>
        <div class="kpi-card entrada">
          <div class="kpi-label">ğŸ“… Ã“rdenes Hoy</div>
          <div class="kpi-value" id="kpiHoy">â€”</div>
          <div class="kpi-sub">Creadas hoy</div>
        </div>
        <div class="kpi-card sal">
          <div class="kpi-label">â³ Pendientes</div>
          <div class="kpi-value" id="kpiPend">â€”</div>
          <div class="kpi-sub">Por realizar</div>
        </div>
        <div class="kpi-card pkg">
          <div class="kpi-label">âœ… Completadas</div>
          <div class="kpi-value" id="kpiComp">â€”</div>
          <div class="kpi-sub">Este mes</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="chip-row">
        <div class="chip active" onclick="setFilter('all',this)">Todas</div>
        <div class="chip" onclick="setFilter('pendiente',this)">â³ Pendientes</div>
        <div class="chip" onclick="setFilter('proceso',this)">ğŸ”„ En proceso</div>
        <div class="chip" onclick="setFilter('completada',this)">âœ… Completadas</div>
      </div>

      <!-- Orders list -->
      <div id="ordersList">
        <div style="text-align:center;padding:30px;color:var(--text-300);">â³ Cargando Ã³rdenes...</div>
      </div>
    </div>
  </div>
</div>

<div class="bottom-nav" id="bottomNav"></div>

<!-- â•â• MODAL: Nueva Orden â•â• -->
<div class="modal-overlay" id="newOrderModal" onclick="if(event.target===this)closeNewOrderModal()">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-icon" style="background:rgba(239,68,68,.1)">ğŸ“‹</div>
      <div>
        <div class="modal-title">Nueva Orden de Salida</div>
        <div class="modal-sub">Carga el Excel del cliente con los SKUs a dar salida</div>
      </div>
      <button class="modal-close" onclick="closeNewOrderModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Cliente <span class="req">*</span></label>
          <select class="form-select" id="noCliente"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Referencia del cliente</label>
          <input class="form-input" id="noRef" placeholder="Ej. REQ-2026-001">
        </div>
        <div class="form-group">
          <label class="form-label">Transporte</label>
          <input class="form-input" id="noTransporte" placeholder="Nombre del transporte">
        </div>
        <div class="form-group">
          <label class="form-label">NÂ° de Orden del cliente</label>
          <input class="form-input" id="noNumOrden" placeholder="Ej. PO-12345">
        </div>
      </div>

      <!-- Excel drop zone -->
      <div style="background:rgba(239,68,68,.04);border:1.5px solid rgba(239,68,68,.2);border-radius:12px;padding:16px;margin-bottom:14px;">
        <div style="font-size:11px;font-weight:800;color:var(--sal-color);margin-bottom:4px;">ğŸ“Š Excel de Salida</div>
        <div style="font-size:10px;color:var(--text-300);margin-bottom:10px;">
          Columnas requeridas: <strong>SKU</strong> + <strong>Cantidad</strong> (el sistema detecta automÃ¡ticamente)
        </div>
        <div class="drop-zone" id="salDropZone"
          onclick="document.getElementById('salFile').click()"
          ondragover="event.preventDefault();this.classList.add('drag-over')"
          ondragleave="this.classList.remove('drag-over')"
          ondrop="event.preventDefault();this.classList.remove('drag-over');handleSalExcel(event.dataTransfer.files[0])">
          <input type="file" id="salFile" accept=".xlsx,.xls,.csv" style="display:none"
            onchange="handleSalExcel(this.files[0])">
          <div style="font-size:26px;margin-bottom:6px;">ğŸ“‚</div>
          <div style="font-size:13px;font-weight:700;color:var(--sal-color);">Arrastra el Excel aquÃ­ o haz clic</div>
          <div style="font-size:11px;color:var(--text-300);margin-top:2px;">.xlsx Â· .xls Â· .csv</div>
        </div>
      </div>

      <!-- SKU preview table -->
      <div id="salPreview" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);">SKUs a dar salida</div>
          <span id="salSkuCount" style="font-size:11px;font-weight:800;color:var(--sal-color);"></span>
        </div>
        <div style="max-height:200px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;">
          <table class="data-table" id="salSkuTable">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Cantidad</th>
                <th>DescripciÃ³n</th>
                <th style="width:30px;"></th>
              </tr>
            </thead>
            <tbody id="salSkuBody"></tbody>
          </table>
        </div>
        <button style="margin-top:8px;width:100%;padding:6px;border-radius:8px;border:1.5px dashed rgba(239,68,68,.3);background:rgba(239,68,68,.03);color:var(--sal-color);font-size:11px;font-weight:700;cursor:pointer;"
          onclick="addManualSku()">ï¼‹ Agregar SKU manual</button>
      </div>

      <div class="form-group" style="margin-top:12px;">
        <label class="form-label">Notas / Instrucciones</label>
        <input class="form-input" id="noNotas" placeholder="Observaciones adicionales...">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeNewOrderModal()">Cancelar</button>
      <button class="btn btn-danger btn-sm" onclick="saveNewOrder()">âœ“ Crear Orden de Salida</button>
    </div>
  </div>
</div>

<!-- â•â• DRAWER: Order detail â•â• -->
<div class="drawer" id="orderDrawer" style="width:420px;">
  <div class="drawer-header">
    <div class="modal-icon" id="dIcon" style="background:rgba(239,68,68,.1);font-size:22px;">ğŸ“‹</div>
    <div style="flex:1;min-width:0;margin-left:10px;">
      <div class="modal-title" id="dFolio"></div>
      <div class="modal-sub" id="dStatus"></div>
    </div>
    <button class="modal-close" onclick="closeOrderDrawer()">âœ•</button>
  </div>
  <div class="drawer-body" id="drawerBody"></div>
  <div class="drawer-footer" id="drawerFooter"></div>
</div>
<div class="sidebar-overlay" id="drawerOverlay" onclick="closeOrderDrawer()"></div>

<!-- â•â• AI VERIFICATION OVERLAY â•â• -->
<div class="ai-overlay" id="aiOverlay">
  <!-- Header -->
  <div style="background:#0a1f5c;color:white;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
    <div>
      <div style="font-family:'Exo 2',sans-serif;font-size:15px;font-weight:900;">ğŸ“¸ Confirmar Orden â€” <span id="aiFolio"></span></div>
      <div style="font-size:11px;color:rgba(255,255,255,.4);margin-top:1px;">Toma foto de cada SKU para confirmar la salida</div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <div id="aiPct" style="font-size:13px;font-weight:900;color:var(--cyan);"></div>
      <button onclick="closeAI()" style="background:rgba(255,255,255,.1);border:none;color:white;width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:14px;">âœ•</button>
    </div>
  </div>

  <!-- Body: 3-panel layout -->
  <div class="ai-panel" style="flex:1;min-height:0;overflow:hidden;">

    <!-- Panel 1: SKU list -->
    <div class="ai-sku-panel" style="background:white;overflow-y:auto;border-right:1px solid #e4eaf8;">
      <div style="padding:10px 12px;background:#f4f8ff;border-bottom:1px solid #e4eaf8;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#6b83c4;">SKUs de la Orden</div>
      <div id="aiSkuList" style="padding:8px;"></div>
    </div>

    <!-- Panel 2: Camera -->
    <div class="ai-camera-panel">
      <div style="position:relative;border-radius:12px;overflow:hidden;width:100%;max-width:480px;aspect-ratio:4/3;background:#111;flex-shrink:0;">
        <video id="aiVideo" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;display:block;"></video>
        <!-- Corner guides -->
        <div style="position:absolute;inset:0;pointer-events:none;">
          <div style="position:absolute;top:10px;left:10px;width:28px;height:28px;border-top:3px solid var(--cyan);border-left:3px solid var(--cyan);border-radius:2px 0 0 0;"></div>
          <div style="position:absolute;top:10px;right:10px;width:28px;height:28px;border-top:3px solid var(--cyan);border-right:3px solid var(--cyan);border-radius:0 2px 0 0;"></div>
          <div style="position:absolute;bottom:10px;left:10px;width:28px;height:28px;border-bottom:3px solid var(--cyan);border-left:3px solid var(--cyan);border-radius:0 0 0 2px;"></div>
          <div style="position:absolute;bottom:10px;right:10px;width:28px;height:28px;border-bottom:3px solid var(--cyan);border-right:3px solid var(--cyan);border-radius:0 0 2px 0;"></div>
        </div>
        <div id="aiScanline" style="position:absolute;left:10px;right:10px;height:2px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);display:none;animation:scanAI 2s ease-in-out infinite;top:30%;"></div>
      </div>
      <div id="aiStatus" style="font-size:12px;color:rgba(255,255,255,.6);text-align:center;min-height:18px;"></div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center;">
        <button id="aiCaptureBtn" onclick="aiCapture()"
          style="background:linear-gradient(135deg,var(--navy),#2d6ef5);color:white;border:none;padding:12px 28px;border-radius:12px;font-size:14px;font-weight:800;cursor:pointer;font-family:'Exo 2',sans-serif;box-shadow:0 4px 20px rgba(45,110,245,.4);">
          ğŸ“¸ Tomar Foto y Verificar
        </button>
        <label style="background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);border:1px solid rgba(255,255,255,.2);padding:12px 16px;border-radius:12px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;">
          ğŸ“ Subir Foto
          <input type="file" accept="image/*" style="display:none" onchange="aiUploadPhoto(this.files[0])">
        </label>
      </div>
      <canvas id="aiCanvas" style="display:none;"></canvas>
    </div>

    <!-- Panel 3: AI Result -->
    <div class="ai-result-panel" style="padding:14px;">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.35);margin-bottom:10px;">Resultado AI</div>
      <div id="aiResult" style="color:rgba(255,255,255,.4);font-size:12px;text-align:center;padding-top:30px;">
        <div style="font-size:30px;margin-bottom:8px;">ğŸ¤–</div>
        <div>Captura una foto para analizar</div>
      </div>
    </div>
  </div>

  <!-- Footer: progress -->
  <div style="background:#0a1f5c;padding:10px 18px;flex-shrink:0;display:flex;align-items:center;gap:16px;">
    <div style="flex:1;">
      <div style="height:5px;background:rgba(255,255,255,.1);border-radius:3px;overflow:hidden;">
        <div id="aiProgressBar" style="height:100%;background:linear-gradient(90deg,var(--cyan),#2d6ef5);border-radius:3px;width:0%;transition:width .4s;"></div>
      </div>
      <div id="aiProgressLbl" style="font-size:10px;color:rgba(255,255,255,.35);margin-top:4px;"></div>
    </div>
    <button id="aiCompleteBtn" onclick="completeOrder()" style="display:none;background:linear-gradient(135deg,#22c77a,#16a34a);color:white;border:none;padding:9px 20px;border-radius:10px;font-size:13px;font-weight:800;cursor:pointer;font-family:'Exo 2',sans-serif;">
      âœ“ Completar Orden
    </button>
  </div>
  <style>@keyframes scanAI{0%,100%{top:10%}50%{top:85%}}</style>
</div>

<div class="toast" id="globalToast"></div>
<script src="../js/core.js"></script>
<script>
// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let USER;
let allOrders  = [];
let salItems   = []; // [{sku, cantidad, descripcion}] for new order
let currentFilter = 'all';

// AI globals
let aiOrderId   = null;
let aiOrderFolio = null;
let aiSkus      = []; // [{sku, cantidad, descripcion, confirmado, item_id}]
let aiStream    = null;
let aiSelIdx    = 0;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  USER = initPage('ordenes');
  if (!USER) return;
  await loadClients();
  await loadOrders();
});

// â”€â”€ Load clients for dropdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadClients() {
  let q = Q.from('clientes').select('id,nombre,codigo').eq('activo', true).order('nombre');
  if (USER.cliente_id) q = q.eq('id', USER.cliente_id);
  const data = await safeQuery(() => q);
  const sel = document.getElementById('noCliente');
  sel.innerHTML = '<option value="">â€” Seleccionar cliente â€”</option>' +
    (data || []).map(c => `<option value="${c.id}">${c.nombre}${c.codigo ? ' ('+c.codigo+')':''}</option>`).join('');
  if (USER.cliente_id && data?.length === 1) sel.value = data[0].id;
}

// â”€â”€ Load orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadOrders() {
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();

  let q = Q.from('ordenes')
    .select(`*, clientes(nombre,color), usuarios!operador_id(nombre,nombre_display)`)
    .gte('created_at', monthStart)
    .order('created_at', { ascending: false });
  if (USER.cliente_id) q = q.eq('cliente_id', USER.cliente_id);
  if (USER.almacen_id) q = q.eq('almacen_origen', USER.almacen_id);

  const data = await safeQuery(() => q);
  allOrders = data || [];
  renderKPIs();
  renderOrders();

  // Pending count for alert badge
  const pend = allOrders.filter(o => o.estado === 'pendiente').length;
  if (pend > 0) {
    document.getElementById('pendingCount').style.display = '';
    document.getElementById('pendingCount').textContent = pend;
  }
}

function renderKPIs() {
  const now = new Date();
  const start = dayStart();
  const hoy = allOrders.filter(o => new Date(o.created_at) >= new Date(start));
  document.getElementById('kpiMes').textContent  = allOrders.length;
  document.getElementById('kpiHoy').textContent  = hoy.length;
  document.getElementById('kpiPend').textContent = allOrders.filter(o=>o.estado==='pendiente').length;
  document.getElementById('kpiComp').textContent = allOrders.filter(o=>o.estado==='completada').length;
}

// â”€â”€ Render order list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f, el) {
  currentFilter = f;
  document.querySelectorAll('.chip-row .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderOrders();
}

function renderOrders() {
  const orders = currentFilter === 'all'
    ? allOrders
    : allOrders.filter(o => o.estado === currentFilter);

  const container = document.getElementById('ordersList');
  if (!orders.length) {
    container.innerHTML = `<div class="empty-state">
      <div class="empty-icon">ğŸ“‹</div>
      <div class="empty-text">Sin Ã³rdenes ${currentFilter !== 'all' ? currentFilter+'s' : ''}</div>
      <div class="empty-sub">Las Ã³rdenes cargadas via Excel aparecerÃ¡n aquÃ­</div>
    </div>`;
    return;
  }

  const stateIcon = { pendiente:'â³', proceso:'ğŸ”„', completada:'âœ…', cancelada:'âœ•' };
  const stateBadge = { pendiente:'badge-warning', proceso:'badge-info', completada:'badge-success', cancelada:'badge-danger' };
  const stateColor = { pendiente:'rgba(245,158,11,.1)', proceso:'rgba(0,194,255,.1)', completada:'rgba(34,199,122,.1)', cancelada:'rgba(239,68,68,.1)' };

  container.innerHTML = orders.map((o, i) => {
    const cl = o.clientes || {};
    const op = o.usuarios?.nombre_display || o.usuarios?.nombre || 'â€”';
    const prog = o.estado === 'completada' ? 100 : o.estado === 'proceso' ? 50 : 0;
    return `<div class="order-card" onclick="openOrderDrawer('${o.id}')">
      <div class="order-type-icon" style="background:${stateColor[o.estado]}">${stateIcon[o.estado]||'ğŸ“‹'}</div>
      <div class="order-info">
        <div class="order-folio">${o.folio || o.id.slice(0,8)}</div>
        <div class="order-meta">
          ${cl.nombre ? `<span class="client-dot" style="background:${cl.color||'#2d6ef5'}"></span>${cl.nombre} Â· ` : ''}
          ${fmtDateTime(o.created_at)}
        </div>
        <div class="order-meta">Ref: ${o.referencia||o.numero_orden||'â€”'} Â· ${op}</div>
        ${prog > 0 ? `<div class="progress-bar"><div class="progress-fill" style="width:${prog}%;background:${prog===100?'var(--success)':'var(--cyan)'}"></div></div>` : ''}
      </div>
      <div class="order-status">
        <span class="badge ${stateBadge[o.estado]}">${o.estado}</span>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ New order modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewOrderModal() {
  salItems = [];
  document.getElementById('salPreview').style.display = 'none';
  document.getElementById('salDropZone').innerHTML = `
    <div style="font-size:26px;margin-bottom:6px;">ğŸ“‚</div>
    <div style="font-size:13px;font-weight:700;color:var(--sal-color);">Arrastra el Excel aquÃ­ o haz clic</div>
    <div style="font-size:11px;color:var(--text-300);margin-top:2px;">.xlsx Â· .xls Â· .csv</div>
    <input type="file" id="salFile" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleSalExcel(this.files[0])">`;
  document.getElementById('newOrderModal').classList.add('open');
}
function closeNewOrderModal() {
  document.getElementById('newOrderModal').classList.remove('open');
}

function handleSalExcel(file) {
  if (!file) return;
  const dz = document.getElementById('salDropZone');
  dz.innerHTML = `<div style="font-size:22px;">â³</div><div style="font-size:12px;font-weight:700;color:var(--text-500);">Leyendo ${file.name}...</div>`;

  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const wb   = XLSX.read(ev.target.result, { type:'array' });
      const ws   = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
      if (!json.length) { showToast('El archivo estÃ¡ vacÃ­o', 'warning'); return; }

      const keys = Object.keys(json[0]);
      const find = (pats) => keys.find(k => pats.some(p => p.test(k.toLowerCase()))) || keys[0];
      const skuKey  = find([/^sku$/i, /folio|c[oÃ³]digo|n[Â°Âº]?\s*parte|part/i]);
      const qtyKey  = find([/cantidad|qty|piezas|units?|bultos?|pcs/i]);
      const descKey = keys.find(k => /desc|product|nombre|artÃ­c/i.test(k.toLowerCase()));

      salItems = json.map(r => ({
        sku:         String(r[skuKey]||'').trim(),
        cantidad:    parseInt(r[qtyKey])||1,
        descripcion: descKey ? String(r[descKey]||'').trim() : '',
      })).filter(r => r.sku);

      if (!salItems.length) { showToast('No se detectaron SKUs', 'warning'); return; }

      dz.innerHTML = `<div style="font-size:22px;">âœ…</div>
        <div style="font-size:12px;font-weight:700;color:var(--success);">${file.name}</div>
        <div style="font-size:11px;color:var(--text-300);">${salItems.length} SKUs detectados Â·
          <span style="color:var(--sal-color);cursor:pointer;font-weight:700;" onclick="document.getElementById('salFile2').click()">Cambiar archivo</span></div>
        <input type="file" id="salFile2" accept=".xlsx,.xls,.csv" style="display:none" onchange="handleSalExcel(this.files[0])">`;

      renderSalPreview();
    } catch(e) { showToast('Error leyendo el archivo', 'error'); }
  };
  reader.readAsArrayBuffer(file);
}

function renderSalPreview() {
  const preview = document.getElementById('salPreview');
  preview.style.display = 'block';
  document.getElementById('salSkuCount').textContent = `${salItems.length} SKU${salItems.length!==1?'s':''}`;
  document.getElementById('salSkuBody').innerHTML = salItems.map((r,i) => `
    <tr>
      <td><input style="border:none;background:none;font-family:monospace;font-size:12px;font-weight:700;color:var(--navy);width:100%;outline:none;"
        value="${r.sku}" oninput="salItems[${i}].sku=this.value"></td>
      <td style="text-align:center;"><input type="number" min="1" style="border:none;background:none;font-weight:800;font-size:14px;width:48px;outline:none;text-align:center;"
        value="${r.cantidad}" oninput="salItems[${i}].cantidad=+this.value||1"></td>
      <td><input style="border:none;background:none;font-size:11px;color:var(--text-400);width:100%;outline:none;"
        value="${r.descripcion}" placeholder="â€”" oninput="salItems[${i}].descripcion=this.value"></td>
      <td><div style="width:20px;height:20px;border-radius:5px;border:1px solid var(--border);background:white;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;color:var(--text-300);"
        onclick="salItems.splice(${i},1);renderSalPreview()">âœ•</div></td>
    </tr>`).join('');
}

function addManualSku() {
  salItems.push({ sku:'', cantidad:1, descripcion:'' });
  renderSalPreview();
}

async function saveNewOrder() {
  const clientId = document.getElementById('noCliente').value;
  const ref      = document.getElementById('noRef').value.trim();
  const transporte = document.getElementById('noTransporte').value.trim();
  const numOrden = document.getElementById('noNumOrden').value.trim();
  const notas    = document.getElementById('noNotas').value.trim();
  const items    = salItems.filter(r => r.sku);

  if (!clientId) { showToast('Selecciona un cliente', 'warning'); return; }
  if (!items.length) { showToast('Carga un Excel o agrega SKUs', 'warning'); return; }

  const btn = document.querySelector('#newOrderModal .btn-danger');
  btn.disabled = true; btn.textContent = 'Guardando...';

  try {
    // Generate folio
    const { data: last } = await Q.from('ordenes').select('folio').like('folio','SAL-%').order('folio',{ascending:false}).limit(1);
    const lastNum = last?.[0]?.folio ? parseInt(last[0].folio.replace(/\D/g,''))||0 : 0;
    const folio = `SAL-${String(lastNum+1).padStart(4,'0')}`;

    // Create order
    const { data: newOrd, error: ordErr } = await Q.from('ordenes').insert({
      folio, tipo:'salida', estado:'pendiente',
      cliente_id: clientId,
      referencia: ref||null, transporte: transporte||null,
      numero_orden: numOrden||null, notas: notas||null,
      operador_id: USER.id,
      ...(USER.almacen_id ? { almacen_origen: USER.almacen_id } : {}),
    }).select('id').single();
    if (ordErr) throw ordErr;

    // Insert items
    await Q.from('orden_items').insert(
      items.map(r => ({
        orden_id: newOrd.id,
        sku: r.sku, cantidad: r.cantidad,
        descripcion: r.descripcion||null, confirmado: false,
      }))
    );

    // Create alert for operators
    await Q.from('alertas').insert({
      tipo: 'operacion', nivel: 'info',
      titulo: `Nueva orden de salida: ${folio}`,
      mensaje: `${items.length} SKUs pendientes de confirmaciÃ³n`,
    });

    showToast(`âœ… Orden ${folio} creada con ${items.length} SKUs`, 'success');
    closeNewOrderModal();
    loadOrders();
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'âœ“ Crear Orden de Salida';
  }
}

// â”€â”€ Order drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openOrderDrawer(orderId) {
  const o = allOrders.find(o => o.id === orderId);
  if (!o) return;

  document.getElementById('dFolio').textContent = o.folio || o.id.slice(0,8);
  const stateLbl = { pendiente:'â³ Pendiente', proceso:'ğŸ”„ En proceso', completada:'âœ… Completada', cancelada:'âœ• Cancelada' };
  const stateCls = { pendiente:'badge-warning', proceso:'badge-info', completada:'badge-success', cancelada:'badge-danger' };
  document.getElementById('dStatus').innerHTML = `<span class="badge ${stateCls[o.estado]}">${stateLbl[o.estado]}</span>`;

  // Load items
  const items = await safeQuery(() => Q.from('orden_items').select('*').eq('orden_id', o.id).order('created_at'));

  const cl = o.clientes || {};
  const body = document.getElementById('drawerBody');

  let html = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
      <div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);">Cliente</div>
        <div style="font-size:13px;font-weight:600;margin-top:2px;">${cl.nombre||'â€”'}</div></div>
      <div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);">Referencia</div>
        <div style="font-size:13px;font-weight:600;margin-top:2px;">${o.referencia||'â€”'}</div></div>
      <div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);">Transporte</div>
        <div style="font-size:13px;font-weight:600;margin-top:2px;">${o.transporte||'â€”'}</div></div>
      <div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);">Sello</div>
        <div style="font-size:13px;font-weight:600;margin-top:2px;">${o.sello||'â€”'}</div></div>
      <div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);">Creada</div>
        <div style="font-size:12px;margin-top:2px;">${fmtDateTime(o.created_at)}</div></div>
      <div><div style="font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);">Notas</div>
        <div style="font-size:12px;margin-top:2px;">${o.notas||'â€”'}</div></div>
    </div>`;

  if (items?.length) {
    const confirmed = items.filter(i => i.confirmado).length;
    html += `<div style="margin-bottom:8px;"><div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text-300);margin-bottom:6px;">
      SKUs (${confirmed}/${items.length} confirmados)</div>`;
    html += `<div class="progress-bar" style="margin-bottom:10px;"><div class="progress-fill" style="width:${items.length?Math.round(confirmed/items.length*100):0}%;background:${confirmed===items.length?'var(--success)':'var(--cyan)'}"></div></div>`;
    items.forEach(item => {
      html += `<div class="sku-scan-item ${item.confirmado?'confirmed':''}">
        <span style="font-size:18px;">${item.confirmado?'âœ…':'â³'}</span>
        <div style="flex:1;">
          <div style="font-family:monospace;font-size:12px;font-weight:800;color:var(--navy);">${item.sku}</div>
          <div style="font-size:10px;color:var(--text-500);">${item.descripcion||''} Â· Cant: ${item.cantidad}</div>
          ${item.confirmado ? `<div style="font-size:9px;color:var(--success);">âœ“ ${fmtTime(item.confirmado_at)}</div>` : ''}
        </div>
      </div>`;
    });
    html += '</div>';
  }

  body.innerHTML = html;

  // Footer
  let footer = `<button class="btn btn-ghost btn-sm" onclick="closeOrderDrawer()">Cerrar</button>`;
  if (o.estado !== 'completada' && o.estado !== 'cancelada') {
    footer += `<button class="btn btn-sm" style="background:linear-gradient(135deg,var(--navy),var(--cyan));color:white;box-shadow:0 3px 12px rgba(0,194,255,.3);"
      onclick="startAIVerification('${o.id}', '${o.folio||o.id.slice(0,8)}')">ğŸ“¸ Confirmar con IA</button>`;
  }
  if (['admin','supervisor'].includes(USER.rol)) {
    footer += `<button class="btn btn-ghost btn-sm" onclick="exportOrder('${o.id}')">ğŸ“¥</button>`;
  }
  document.getElementById('drawerFooter').innerHTML = footer;

  document.getElementById('orderDrawer').classList.add('open');
  document.getElementById('drawerOverlay').classList.add('open');
}

function closeOrderDrawer() {
  document.getElementById('orderDrawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
}

async function exportOrder(orderId) {
  const items = await safeQuery(() => Q.from('orden_items').select('*').eq('orden_id', orderId));
  if (!items?.length) { showToast('Sin items para exportar', 'warning'); return; }
  exportXLSX(items, `orden_${orderId.slice(0,8)}`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI VERIFICATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startAIVerification(orderId, folio) {
  closeOrderDrawer();
  aiOrderId    = orderId;
  aiOrderFolio = folio;
  aiSkus       = [];
  aiSelIdx     = 0;

  // Load items
  const items = await safeQuery(() => Q.from('orden_items').select('*').eq('orden_id', orderId).order('created_at'));
  if (!items?.length) { showToast('No hay SKUs en esta orden', 'warning'); return; }

  aiSkus = items.map(r => ({
    sku: r.sku, cantidad: r.cantidad,
    descripcion: r.descripcion||'', confirmado: r.confirmado||false, item_id: r.id,
  }));

  document.getElementById('aiFolio').textContent = folio;
  renderAiSkuList();
  document.getElementById('aiOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  startCamera();
}

function renderAiSkuList() {
  const list = document.getElementById('aiSkuList');
  list.innerHTML = aiSkus.map((s,i) => `
    <div id="aiS${i}" onclick="selectAiSku(${i})"
      style="border-radius:9px;padding:9px 11px;cursor:pointer;border:1.5px solid ${s.confirmado?'rgba(34,199,122,.4)':'#e4eaf8'};
        background:${s.confirmado?'rgba(34,199,122,.06)':'white'};margin-bottom:6px;transition:all .15s;">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <span style="font-family:monospace;font-size:12px;font-weight:800;color:${s.confirmado?'#16a34a':'var(--navy)'};">${s.sku}</span>
        <span>${s.confirmado?'âœ…':'â³'}</span>
      </div>
      <div style="font-size:10px;color:#94a3b8;margin-top:2px;">${s.cantidad} ud${s.descripcion?' Â· '+s.descripcion.slice(0,28):''}</div>
    </div>`).join('');

  const confirmed = aiSkus.filter(s => s.confirmado).length;
  const total = aiSkus.length;
  const pct = total ? Math.round(confirmed/total*100) : 0;
  document.getElementById('aiProgressBar').style.width = pct + '%';
  document.getElementById('aiProgressLbl').textContent = `${confirmed} / ${total} SKUs confirmados`;
  document.getElementById('aiPct').textContent = pct + '%';
  document.getElementById('aiCompleteBtn').style.display = confirmed === total && total > 0 ? '' : 'none';

  // Auto-select first pending
  const next = aiSkus.findIndex(s => !s.confirmado);
  if (next >= 0) selectAiSku(next);
}

function selectAiSku(idx) {
  aiSelIdx = idx;
  document.querySelectorAll('[id^="aiS"]').forEach((el,i) => {
    el.style.outline = i === idx ? '2px solid var(--cyan)' : 'none';
  });
  const s = aiSkus[idx];
  if (s) document.getElementById('aiStatus').textContent =
    s.confirmado ? `âœ… ${s.sku} ya confirmado` : `Apunta al SKU: ${s.sku}`;
}

async function startCamera() {
  try {
    aiStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:'environment' }, width: { ideal:1280 } }
    });
    document.getElementById('aiVideo').srcObject = aiStream;
    document.getElementById('aiStatus').textContent = 'CÃ¡mara lista â€” apunta al cÃ³digo del bulto';
  } catch(e) {
    document.getElementById('aiStatus').textContent = 'âš ï¸ Sin cÃ¡mara â€” usa "Subir Foto"';
  }
}

function stopCamera() {
  aiStream?.getTracks().forEach(t => t.stop());
  aiStream = null;
}

async function aiCapture() {
  const video = document.getElementById('aiVideo');
  const canvas = document.getElementById('aiCanvas');
  if (!video.videoWidth) { showToast('CÃ¡mara no disponible', 'warning'); return; }
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  await aiAnalyze(canvas.toDataURL('image/jpeg', 0.85).split(',')[1]);
}

async function aiUploadPhoto(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async ev => await aiAnalyze(ev.target.result.split(',')[1]);
  reader.readAsDataURL(file);
}

async function aiAnalyze(base64) {
  const scanline  = document.getElementById('aiScanline');
  const captureBtn = document.getElementById('aiCaptureBtn');
  const status    = document.getElementById('aiStatus');
  const resultEl  = document.getElementById('aiResult');

  scanline.style.display = 'block';
  captureBtn.disabled = true;
  captureBtn.textContent = 'ğŸ” Analizando...';
  status.textContent = 'Enviando a Claude Vision...';
  resultEl.innerHTML = '<div style="font-size:24px;margin-bottom:8px;">â³</div><div style="font-size:11px;color:rgba(255,255,255,.4);">Analizando imagen...</div>';

  const pending  = aiSkus.filter(s => !s.confirmado).map(s => s.sku);
  const allSkus  = aiSkus.map(s => s.sku);

  try {
    const prompt = `Eres un sistema WMS de verificaciÃ³n de almacÃ©n.

SKUs de la orden: ${allSkus.join(', ')}
SKUs pendientes: ${pending.join(', ')}

Analiza la imagen y lee TODOS los textos, etiquetas y cÃ³digos visibles.
Identifica quÃ© SKU de la lista PENDIENTE aparece en la imagen.

Responde SOLO con este JSON (sin markdown):
{"sku_detectado":"texto exacto visto o null","sku_coincide":"SKU de la lista que coincide o null","coincidencia":true/false,"confianza":"alta/media/baja","texto_visible":"todo el texto legible","razon":"explicaciÃ³n breve"}`;

    const data = await callVision(base64, 'image/jpeg', prompt);

    // Parse response â€” handles both structured and text formats
    let parsed = null;
    const candidates = [data, data?.text, data?.content].filter(Boolean);
    for (const c of candidates) {
      if (typeof c === 'object' && c.coincidencia !== undefined) { parsed = c; break; }
      if (typeof c === 'string') {
        try {
          const m = c.match(/\{[\s\S]*?\}/);
          if (m) { const p = JSON.parse(m[0]); if (p.coincidencia !== undefined) { parsed = p; break; } }
        } catch {}
      }
    }

    // Fallback if EF returned structured inventory data (sku field)
    if (!parsed && (data?.sku || data?.text)) {
      const det = data.sku || '';
      const matched = pending.find(s => s === det || s.toLowerCase() === det.toLowerCase() || s.includes(det) || det.includes(s));
      parsed = { sku_detectado: det||null, sku_coincide: matched||null, coincidencia: !!matched,
        confianza: data.confidence > 0.8 ? 'alta' : 'media',
        texto_visible: data.text || det, razon: 'Detectado por Vision' };
    }

    if (!parsed) {
      resultEl.innerHTML = `<div style="color:#ef4444;padding:10px;font-size:12px;">No se pudo interpretar la respuesta AI.<br><small style="color:rgba(255,255,255,.3)">${JSON.stringify(data).slice(0,200)}</small></div>`;
      status.textContent = 'âš ï¸ Intenta de nuevo con mejor iluminaciÃ³n';
      return;
    }

    // Display result
    const match = parsed.coincidencia === true;
    const confColor = { alta:'#22c77a', media:'#f59e0b', baja:'#ef4444' }[parsed.confianza] || '#94a3b8';
    resultEl.innerHTML = `
      <div style="text-align:center;padding:14px 0 10px;">
        <div style="font-size:36px;">${match?'âœ…':'âŒ'}</div>
        <div style="font-size:13px;font-weight:800;color:${match?'#22c77a':'#ef4444'};margin-top:6px;">${match?'âœ“ SKU Confirmado':'âœ• Sin coincidencia'}</div>
        ${parsed.sku_detectado ? `<div style="font-family:monospace;font-size:11px;background:rgba(255,255,255,.06);padding:3px 10px;border-radius:6px;margin-top:5px;display:inline-block;color:white;">${parsed.sku_detectado}</div>` : ''}
      </div>
      <div style="font-size:11px;color:rgba(255,255,255,.5);padding:0 4px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span>Confianza</span>
          <span style="font-weight:700;color:${confColor}">${parsed.confianza}</span>
        </div>
        ${parsed.sku_coincide ? `<div style="margin-bottom:5px;"><span>Coincide:</span> <strong style="font-family:monospace;color:#00c2ff">${parsed.sku_coincide}</strong></div>` : ''}
        <div style="color:rgba(255,255,255,.3);margin-bottom:4px;">Texto detectado:</div>
        <div style="font-family:monospace;font-size:10px;color:rgba(255,255,255,.6);word-break:break-all;background:rgba(255,255,255,.05);padding:5px;border-radius:5px;margin-bottom:6px;">${parsed.texto_visible||'â€”'}</div>
        <div style="font-size:10px;border-top:1px solid rgba(255,255,255,.08);padding-top:5px;color:rgba(255,255,255,.3);">${parsed.razon||''}</div>
      </div>`;

    if (match && parsed.sku_coincide) {
      const idx = aiSkus.findIndex(s => s.sku === parsed.sku_coincide && !s.confirmado);
      if (idx >= 0) {
        aiSkus[idx].confirmado = true;
        renderAiSkuList();
        persistConfirmation(aiSkus[idx]);
        const remaining = aiSkus.filter(s => !s.confirmado).length;
        status.textContent = remaining > 0 ? `âœ… ${parsed.sku_coincide} â€” ${remaining} restantes` : 'ğŸ‰ Â¡Todos confirmados!';
      }
    } else {
      status.textContent = parsed.sku_detectado
        ? `âŒ "${parsed.sku_detectado}" no estÃ¡ en la orden`
        : 'âŒ Sin SKU detectado â€” ajusta el Ã¡ngulo';
    }
  } catch(e) {
    resultEl.innerHTML = `<div style="color:#ef4444;font-size:12px;padding:10px;">Error de red: ${e.message}</div>`;
    status.textContent = 'âš ï¸ Error de conexiÃ³n';
  } finally {
    scanline.style.display = 'none';
    captureBtn.disabled = false;
    captureBtn.textContent = 'ğŸ“¸ Tomar Foto y Verificar';
  }
}

async function persistConfirmation(item) {
  if (!item.item_id) return;
  try {
    await Q.from('orden_items')
      .update({ confirmado: true, confirmado_at: new Date().toISOString() })
      .eq('id', item.item_id);
  } catch(e) { console.warn('Persist failed:', e.message); }
}

async function completeOrder() {
  const confirmed = aiSkus.filter(s => s.confirmado);
  const pending   = aiSkus.filter(s => !s.confirmado);
  if (pending.length > 0) {
    if (!confirm(`${pending.length} SKU(s) sin confirmar. Â¿Completar la orden de todas formas?`)) return;
  }

  try {
    // Update order status
    await Q.from('ordenes').update({ estado:'completada', fecha_completada: new Date().toISOString() }).eq('id', aiOrderId);

    // Update inventory status for confirmed SKUs
    for (const item of confirmed) {
      await Q.from('inventario').update({ estado:'salida_total' }).eq('sku', item.sku);
    }

    // Generate Excel report
    const reportData = aiSkus.map(s => ({
      SKU: s.sku, Cantidad: s.cantidad, DescripciÃ³n: s.descripcion,
      Confirmado: s.confirmado ? 'SÃ­' : 'No',
      'Confirmado a las': s.confirmado_at ? fmtTime(s.confirmado_at) : 'â€”',
    }));
    exportXLSX(reportData, `orden_${aiOrderFolio}_confirmacion`);

    showToast(`âœ… Orden ${aiOrderFolio} completada â€” ${confirmed.length} salidas registradas`, 'success', 4000);
    closeAI();
    loadOrders();
  } catch(e) {
    showToast('Error: ' + e.message, 'error');
  }
}

function closeAI() {
  stopCamera();
  document.getElementById('aiOverlay').classList.remove('open');
  document.body.style.overflow = '';
}
</script>
</body>
</html>
