<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IDEA SCAN 2.0 â€” Inventario</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'><text y='32' font-size='32'>ğŸ“¦</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;800;900&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" href="../css/app.css">
<style>
/* â”€â”€ Inventory specific â”€â”€ */
.inv-search { max-width:420px; }
.inv-row { cursor: pointer; }
.inv-row:hover td { background: var(--surface); }
.sku-cell {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px; font-weight: 700;
  color: var(--navy); letter-spacing: .5px;
}
.client-dot {
  width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px;
}

/* â”€â”€ Status badges â”€â”€ */
.status-activo    { background: rgba(34,199,122,.1);  color: #16a34a; }
.status-reservado { background: rgba(245,158,11,.1);  color: #b45309; }
.status-salida_parcial { background: rgba(0,194,255,.1); color: #0077aa; }
.status-salida_total   { background: rgba(239,68,68,.1);  color: #dc2626; }

/* â”€â”€ Mobile inventory cards â”€â”€ */
.inv-card {
  background: white; border-radius: 12px;
  border: 1px solid var(--border); padding: 14px;
  margin-bottom: 10px; cursor: pointer;
  box-shadow: 0 1px 6px rgba(13,43,122,.06);
  transition: all .18s;
}
.inv-card:hover { border-color: var(--cyan); transform: translateY(-1px); }
.inv-card-sku {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px; font-weight: 800; color: var(--navy);
  margin-bottom: 4px;
}
.inv-card-meta { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }

/* â”€â”€ Drawer detail â”€â”€ */
.detail-field { margin-bottom: 12px; }
.detail-label {
  font-size: 9px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px;
  color: var(--text-300); margin-bottom: 3px;
}
.detail-value { font-size: 13px; color: var(--text-900); font-weight: 500; }
.detail-value.mono { font-family: 'JetBrains Mono', monospace; font-size: 12px; }
.detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 20px; }

/* â”€â”€ Image gallery â”€â”€ */
.img-gallery { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-top: 10px; }
.img-thumb {
  aspect-ratio: 1; border-radius: 8px; overflow: hidden;
  border: 1px solid var(--border); cursor: pointer; position: relative;
}
.img-thumb img { width:100%; height:100%; object-fit:cover; }
.img-thumb::after {
  content: 'ğŸ”';
  position: absolute; inset: 0;
  background: rgba(0,0,0,.4); display: flex;
  align-items: center; justify-content: center;
  font-size: 20px; opacity: 0; transition: opacity .2s;
}
.img-thumb:hover::after { opacity: 1; }

/* â”€â”€ KPI click areas â”€â”€ */
.kpi-card.clickable { cursor: pointer; }

/* â”€â”€ Alert bell â”€â”€ */
.alert-badge { position: absolute; top:-6px; right:-6px; }

/* â”€â”€ Day detail modal â”€â”€ */
.day-item {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--border);
}
.day-item:last-child { border-bottom: none; }
.day-item-time {
  font-size: 10px; font-weight: 700; color: var(--text-300);
  white-space: nowrap; min-width: 52px; padding-top: 2px;
}
.day-item-content { flex: 1; }
.day-item-sku { font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 800; color: var(--navy); }
.day-item-meta { font-size: 11px; color: var(--text-500); margin-top: 2px; }
.day-item-by { font-size: 10px; color: var(--text-300); margin-top: 1px; }

/* â”€â”€ Empty state â”€â”€ */
.empty-state {
  text-align: center; padding: 48px 20px; color: var(--text-300);
}
.empty-icon { font-size: 48px; margin-bottom: 10px; }
.empty-text { font-size: 14px; font-weight: 600; color: var(--text-500); }
.empty-sub  { font-size: 12px; margin-top: 4px; }
</style>
</head>
<body>
<div class="app-shell">

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar"></nav>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Main -->
  <div class="main-content">

    <!-- Header -->
    <div class="top-header">
      <button class="hamburger" onclick="toggleSidebar()" aria-label="MenÃº">
        <span></span>
      </button>
      <div class="header-title">Inventario <span>WMS</span></div>
      <div class="header-actions">
        <!-- Search -->
        <div class="search-bar inv-search desktop-only">
          <span>ğŸ”</span>
          <input type="text" id="searchInput" placeholder="SKU, Tracking, NÂ° Parte..."
            oninput="filterInventory(this.value)">
          <span id="searchClear" style="cursor:pointer;display:none;" onclick="clearSearch()">âœ•</span>
        </div>
        <!-- Alerts bell -->
        <button class="header-btn" id="alertBtn" onclick="openAlerts()" title="Alertas">
          ğŸ””
          <span class="badge" id="alertCount" style="display:none">0</span>
        </button>
        <!-- Download (admin/supervisor) -->
        <button class="header-btn" id="downloadBtn" onclick="exportInventory()" title="Exportar Excel" style="display:none">ğŸ“¥</button>
      </div>
    </div>

    <!-- Page body -->
    <div class="page-body">

      <!-- Mobile search -->
      <div class="search-bar mobile-only mb-16">
        <span>ğŸ”</span>
        <input type="text" placeholder="SKU, Tracking, NÂ° Parte..."
          oninput="filterInventory(this.value)">
      </div>

      <!-- KPI Cards -->
      <div class="kpi-grid">
        <div class="kpi-card inv clickable" onclick="openDayModal('entradas')">
          <div class="kpi-label">SKUs en Inventario</div>
          <div class="kpi-value" id="kpiTotal">â€”</div>
          <div class="kpi-sub">Total registros activos</div>
        </div>
        <div class="kpi-card entrada clickable" onclick="openDayModal('entradas')">
          <div class="kpi-label">ğŸ“¥ Entradas Hoy</div>
          <div class="kpi-value" id="kpiEntradas">â€”</div>
          <div class="kpi-sub">SKUs registrados hoy</div>
        </div>
        <div class="kpi-card sal clickable" onclick="openDayModal('salidas')">
          <div class="kpi-label">ğŸ“¤ Salidas Hoy</div>
          <div class="kpi-value" id="kpiSalidas">â€”</div>
          <div class="kpi-sub">Basado en Ã³rdenes</div>
        </div>
        <div class="kpi-card pkg clickable" onclick="openDayModal('paqueteria')">
          <div class="kpi-label">ğŸ“¦ PaqueterÃ­a Hoy</div>
          <div class="kpi-value" id="kpiPkg">â€”</div>
          <div class="kpi-sub">Paquetes capturados</div>
        </div>
      </div>

      <!-- Filter chips -->
      <div class="chip-row" id="clientChips">
        <div class="chip active" data-filter="all" onclick="setClientFilter('all', this)">Todos</div>
      </div>

      <!-- Table: desktop -->
      <div class="data-table-wrap desktop-only">
        <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);">
          <div class="section-title">ğŸ“¦ Inventario Actual</div>
          <div style="font-size:11px;color:var(--text-300);" id="tableCount"></div>
        </div>
        <div style="overflow-x:auto;">
          <table class="data-table" id="invTable">
            <thead>
              <tr>
                <th>SKU</th>
                <th>Cliente</th>
                <th>NÂ° Parte</th>
                <th>DescripciÃ³n</th>
                <th>Cantidad</th>
                <th>Bultos</th>
                <th>UbicaciÃ³n</th>
                <th>Tracking</th>
                <th>AlmacÃ©n</th>
                <th>Fecha Entrada</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="invTableBody">
              <tr><td colspan="11" class="empty-state">
                <div class="empty-icon">â³</div>
                <div class="empty-text">Cargando inventario...</div>
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Cards: mobile -->
      <div class="mobile-cards" id="invCards"></div>

    </div><!-- /page-body -->
  </div><!-- /main-content -->
</div><!-- /app-shell -->

<!-- Bottom nav (mobile) -->
<div class="bottom-nav" id="bottomNav"></div>

<!-- â•â• DRAWER: Item detail â•â• -->
<div class="drawer" id="itemDrawer">
  <div class="drawer-header">
    <div>
      <div class="modal-title" id="dSku" style="font-family:'JetBrains Mono',monospace;font-size:15px;"></div>
      <div class="modal-sub" id="dStatus"></div>
    </div>
    <button class="modal-close" onclick="closeDrawer()" style="margin-left:auto;">âœ•</button>
  </div>
  <div class="drawer-body" id="drawerBody"></div>
  <div class="drawer-footer" id="drawerFooter"></div>
</div>
<div class="sidebar-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>

<!-- â•â• MODAL: Day detail (entradas/salidas/paqueteria) â•â• -->
<div class="modal-overlay" id="dayModal" onclick="if(event.target===this)closeDayModal()">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-icon" id="dayModalIcon" style="background:rgba(34,199,122,.1)">ğŸ“¥</div>
      <div>
        <div class="modal-title" id="dayModalTitle">Entradas del dÃ­a</div>
        <div class="modal-sub" id="dayModalSub"></div>
      </div>
      <button class="modal-close" onclick="closeDayModal()">âœ•</button>
    </div>
    <div class="modal-body" id="dayModalBody" style="padding:0 22px 20px;"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost btn-sm" onclick="closeDayModal()">Cerrar</button>
      <button class="btn btn-primary btn-sm" onclick="exportDayReport()">ğŸ“¥ Exportar</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: Alerts â•â• -->
<div class="modal-overlay" id="alertsModal" onclick="if(event.target===this)closeAlerts()">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon" style="background:rgba(245,158,11,.1)">ğŸ””</div>
      <div>
        <div class="modal-title">Alertas</div>
        <div class="modal-sub">Notificaciones del sistema</div>
      </div>
      <button class="modal-close" onclick="closeAlerts()">âœ•</button>
    </div>
    <div class="modal-body" id="alertsBody"></div>
  </div>
</div>

<!-- â•â• MODAL: Image lightbox â•â• -->
<div class="modal-overlay" id="lightboxModal" onclick="closeLightbox()" style="background:rgba(0,0,0,.9)">
  <div style="position:relative;max-width:90vw;max-height:90vh;">
    <img id="lightboxImg" style="max-width:90vw;max-height:90vh;border-radius:12px;object-fit:contain;" src="">
    <button onclick="closeLightbox()" style="position:absolute;top:-14px;right:-14px;width:32px;height:32px;border-radius:50%;background:white;border:none;font-size:16px;cursor:pointer;">âœ•</button>
    <a id="lightboxDownload" download style="position:absolute;bottom:-44px;left:50%;transform:translateX(-50%);background:white;color:#0d2b7a;padding:8px 20px;border-radius:20px;font-size:12px;font-weight:700;text-decoration:none;">ğŸ“¥ Descargar PNG</a>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="globalToast"></div>

<!-- â•â• SCRIPTS â•â• -->
<script src="../js/core.js"></script>
<script>
// â”€â”€ Globals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let USER;
let allInventory = [];
let filteredInventory = [];
let activeClientFilter = 'all';
let clientMap = {};     // id â†’ {nombre, color, codigo}
let almacenMap = {};    // id â†’ nombre
let currentDayType = null;
let dayModalData = [];

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  USER = initPage('inventario');
  if (!USER) return;

  // Show export button for admin/supervisor
  if (['admin','supervisor'].includes(USER.rol)) {
    document.getElementById('downloadBtn').style.display = '';
  }

  await loadMeta();
  await loadInventory();
  loadKPIs();
  loadAlerts();
});

// â”€â”€ Load reference data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadMeta() {
  const [cls, alms] = await Promise.all([
    safeQuery(() => Q.from('clientes').select('id,nombre,codigo,color')),
    safeQuery(() => Q.from('almacenes').select('id,nombre')),
  ]);
  (cls || []).forEach(c => clientMap[c.id] = c);
  (alms || []).forEach(a => almacenMap[a.id] = a.nombre);

  // Render client filter chips
  const chips = document.getElementById('clientChips');
  const visible = (cls || []).filter(c => {
    if (USER.rol === 'admin' || USER.rol === 'supervisor') return true;
    if (USER.cliente_id) return c.id === USER.cliente_id;
    return true;
  });
  visible.forEach(c => {
    const d = document.createElement('div');
    d.className = 'chip';
    d.dataset.filter = c.id;
    d.style.borderColor = c.color || '#2d6ef5';
    d.innerHTML = `<span class="client-dot" style="background:${c.color||'#2d6ef5'}"></span>${c.nombre}`;
    d.onclick = () => setClientFilter(c.id, d);
    chips.appendChild(d);
  });
}

// â”€â”€ Load inventory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadInventory() {
  let q = Q.from('inventario')
    .select(`*, clientes(nombre,codigo,color), almacenes(nombre), usuarios!operador_id(nombre,nombre_display)`)
    .eq('activo', true)
    .order('created_at', { ascending: false });

  // Scope by role
  if (USER.rol === 'cliente' && USER.cliente_id) q = q.eq('cliente_id', USER.cliente_id);
  if (USER.rol === 'operador' && USER.cliente_id) q = q.eq('cliente_id', USER.cliente_id);
  if (USER.rol === 'operador' && USER.almacen_id) q = q.eq('almacen_id', USER.almacen_id);

  const data = await safeQuery(() => q);
  allInventory = data || [];
  filteredInventory = [...allInventory];
  renderInventory();
}

// â”€â”€ Load KPIs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadKPIs() {
  const start = dayStart();
  const end   = dayEnd();

  // Total SKUs
  document.getElementById('kpiTotal').textContent = allInventory.filter(i => i.estado !== 'salida_total').length;

  // Entradas hoy: inventario created today
  let q = Q.from('inventario').select('id', { count:'exact', head:true })
    .gte('created_at', start).lte('created_at', end);
  if (USER.cliente_id) q = q.eq('cliente_id', USER.cliente_id);
  const { count: entCount } = await q;
  document.getElementById('kpiEntradas').textContent = entCount || 0;

  // Salidas hoy: orden_items confirmadas hoy
  let qs = Q.from('orden_items').select('id', { count:'exact', head:true })
    .eq('confirmado', true).gte('confirmado_at', start).lte('confirmado_at', end);
  const { count: salCount } = await qs;
  document.getElementById('kpiSalidas').textContent = salCount || 0;

  // Paqueteria hoy
  let qp = Q.from('paqueteria').select('id', { count:'exact', head:true })
    .gte('created_at', start).lte('created_at', end);
  if (USER.cliente_id) qp = qp.eq('cliente_id', USER.cliente_id);
  const { count: pkgCount } = await qp;
  document.getElementById('kpiPkg').textContent = pkgCount || 0;
}

// â”€â”€ Filter & Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setClientFilter(clientId, el) {
  document.querySelectorAll('#clientChips .chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  activeClientFilter = clientId;
  filterInventory(document.getElementById('searchInput')?.value || '');
}

function filterInventory(query) {
  const q = (query || '').toLowerCase().trim();
  const searchClear = document.getElementById('searchClear');
  if (searchClear) searchClear.style.display = q ? 'block' : 'none';

  filteredInventory = allInventory.filter(item => {
    // Client filter
    if (activeClientFilter !== 'all' && item.cliente_id !== activeClientFilter) return false;
    // Text search
    if (q) {
      const haystack = [
        item.sku, item.numero_parte, item.tracking_number,
        item.descripcion, item.po, item.serial_number,
        item.vendor, item.lote
      ].join(' ').toLowerCase();
      if (!haystack.includes(q)) return false;
    }
    return true;
  });
  renderInventory();
}

function clearSearch() {
  document.getElementById('searchInput').value = '';
  filterInventory('');
}

function renderInventory() {
  renderTable();
  renderCards();
  document.getElementById('tableCount').textContent = `${filteredInventory.length} registros`;
}

function renderTable() {
  const tbody = document.getElementById('invTableBody');
  if (!filteredInventory.length) {
    tbody.innerHTML = `<tr><td colspan="11">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <div class="empty-text">Sin registros en inventario</div>
        <div class="empty-sub">Los SKUs capturados con IA aparecerÃ¡n aquÃ­</div>
      </div>
    </td></tr>`;
    return;
  }
  tbody.innerHTML = filteredInventory.map((item, i) => {
    const cl = clientMap[item.cliente_id] || {};
    const dot = cl.color ? `<span class="client-dot" style="background:${cl.color}"></span>` : '';
    const statusClass = `status-${item.estado}`;
    const statusLbl = { activo:'âœ“ Activo', reservado:'â¸ Reservado', salida_parcial:'â†— Salida Parcial', salida_total:'â†‘ Salida Total' }[item.estado] || item.estado;
    return `<tr class="inv-row" onclick="openItem(${i})">
      <td class="sku-cell">${item.sku}</td>
      <td>${dot}${cl.nombre || 'â€”'}</td>
      <td class="mono" style="font-size:11px;">${item.numero_parte || 'â€”'}</td>
      <td style="max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${item.descripcion || 'â€”'}</td>
      <td style="text-align:center;font-weight:700;">${item.cantidad || 0}</td>
      <td style="text-align:center;">${item.bultos || 'â€”'}</td>
      <td style="font-size:11px;">${item.ubicacion || item.zona || 'â€”'}</td>
      <td class="mono" style="font-size:11px;">${item.tracking_number || 'â€”'}</td>
      <td style="font-size:11px;">${almacenMap[item.almacen_id] || 'â€”'}</td>
      <td style="font-size:11px;">${fmtDate(item.fecha_entrada || item.created_at)}</td>
      <td><span class="badge ${statusClass}">${statusLbl}</span></td>
    </tr>`;
  }).join('');
}

function renderCards() {
  const container = document.getElementById('invCards');
  if (!filteredInventory.length) {
    container.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Sin registros</div></div>`;
    return;
  }
  container.innerHTML = filteredInventory.map((item, i) => {
    const cl = clientMap[item.cliente_id] || {};
    const statusLbl = { activo:'âœ“ Activo', reservado:'â¸ Reservado', salida_parcial:'â†— Parcial', salida_total:'â†‘ Salida' }[item.estado] || item.estado;
    const statusClass = `badge status-${item.estado}`;
    return `<div class="inv-card" onclick="openItem(${i})">
      <div class="flex-between">
        <div class="inv-card-sku">${item.sku}</div>
        <span class="${statusClass}">${statusLbl}</span>
      </div>
      <div style="font-size:12px;color:var(--text-500);margin-top:2px;">${item.descripcion || 'â€”'}</div>
      <div class="inv-card-meta">
        ${cl.nombre ? `<span class="badge badge-navy"><span class="client-dot" style="background:${cl.color||'#2d6ef5'}"></span>${cl.nombre}</span>` : ''}
        ${item.numero_parte ? `<span class="badge badge-info">ğŸ“‹ ${item.numero_parte}</span>` : ''}
        ${item.cantidad ? `<span class="badge badge-navy">ğŸ”¢ ${item.cantidad} ud</span>` : ''}
        ${item.tracking_number ? `<span class="badge badge-navy">ğŸ”– ${item.tracking_number.slice(-8)}</span>` : ''}
        <span class="badge badge-navy">ğŸ“… ${fmtDate(item.fecha_entrada||item.created_at)}</span>
      </div>
    </div>`;
  }).join('');
}

// â”€â”€ Item Drawer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openItem(idx) {
  const item = filteredInventory[idx];
  if (!item) return;
  const cl = clientMap[item.cliente_id] || {};

  document.getElementById('dSku').textContent = item.sku;
  const statusLbl = { activo:'âœ“ Activo', reservado:'â¸ Reservado', salida_parcial:'â†— Salida Parcial', salida_total:'â†‘ Salida Total' }[item.estado] || item.estado;
  document.getElementById('dStatus').innerHTML = `<span class="badge status-${item.estado}">${statusLbl}</span>`;

  // Get client fields config
  const campos = cl.campos_captura || ['sku','numero_parte','descripcion','cantidad','bultos','peso','po','serial_number','tracking_number','vendor','origin','part_model'];

  const fieldMap = {
    sku:            ['SKU', item.sku],
    numero_parte:   ['NÂ° de Parte', item.numero_parte],
    descripcion:    ['DescripciÃ³n', item.descripcion],
    cantidad:       ['Cantidad', item.cantidad],
    bultos:         ['Bultos', item.bultos],
    peso:           ['Peso', item.peso],
    po:             ['PO', item.po],
    serial_number:  ['Serial Number', item.serial_number],
    tracking_number:['Tracking Number', item.tracking_number],
    vendor:         ['Vendor', item.vendor],
    origin:         ['Origin', item.origin],
    part_model:     ['Part Model', item.part_model],
  };

  let fieldsHTML = '<div class="detail-grid">';
  campos.forEach(k => {
    const [label, value] = fieldMap[k] || [k, item[k]];
    if (!value) return;
    const isMono = ['sku','numero_parte','tracking_number','serial_number','po','part_model'].includes(k);
    fieldsHTML += `<div class="detail-field">
      <div class="detail-label">${label}</div>
      <div class="detail-value${isMono?' mono':''}">${value}</div>
    </div>`;
  });
  fieldsHTML += '</div>';

  // Extra info
  fieldsHTML += `<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);">
    <div class="detail-field"><div class="detail-label">Cliente</div><div class="detail-value">${cl.nombre||'â€”'}</div></div>
    <div class="detail-field"><div class="detail-label">AlmacÃ©n</div><div class="detail-value">${almacenMap[item.almacen_id]||'â€”'}</div></div>
    <div class="detail-field"><div class="detail-label">UbicaciÃ³n / Zona</div><div class="detail-value">${item.ubicacion||item.zona||'â€”'}</div></div>
    <div class="detail-field"><div class="detail-label">Folio de Entrada</div><div class="detail-value mono">${item.folio_entrada||'â€”'}</div></div>
    <div class="detail-field"><div class="detail-label">Fecha de Entrada</div><div class="detail-value">${fmtDateTime(item.fecha_entrada||item.created_at)}</div></div>
  </div>`;

  // Images
  const imgs = item.imagenes || [];
  if (imgs.length) {
    fieldsHTML += `<div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);">
      <div class="detail-label">ğŸ“· ImÃ¡genes (${imgs.length})</div>
      <div class="img-gallery">${imgs.map(url => `
        <div class="img-thumb" onclick="openLightbox('${url}')">
          <img src="${url}" alt="Imagen" loading="lazy">
        </div>`).join('')}
      </div>
    </div>`;
  }

  document.getElementById('drawerBody').innerHTML = fieldsHTML;

  // Footer buttons
  let footer = `<button class="btn btn-ghost btn-sm" onclick="closeDrawer()">Cerrar</button>`;
  footer += `<button class="btn btn-primary btn-sm" onclick="downloadItemExcel(${idx})">ğŸ“¥ Excel</button>`;
  if (imgs.length) footer += `<button class="btn btn-ghost btn-sm" onclick="downloadImages(${idx})">ğŸ“· Imgs</button>`;
  if (['admin','supervisor','operador'].includes(USER.rol)) {
    footer += `<button class="btn btn-ghost btn-sm" onclick="reprintLabel(${idx})">ğŸ–¨ï¸ Label</button>`;
  }
  document.getElementById('drawerFooter').innerHTML = footer;

  document.getElementById('itemDrawer').classList.add('open');
  document.getElementById('drawerOverlay').classList.add('open');
}

function closeDrawer() {
  document.getElementById('itemDrawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
}

// â”€â”€ Excel download for single item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadItemExcel(idx) {
  const item = filteredInventory[idx];
  const cl = clientMap[item.cliente_id] || {};
  const campos = cl.campos_captura || Object.keys(item);
  const row = {};
  campos.forEach(k => { row[k] = item[k]; });
  exportXLSX([row], `${item.sku}_detalle`);
}

// â”€â”€ Images download (just opens them) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function downloadImages(idx) {
  const imgs = filteredInventory[idx]?.imagenes || [];
  imgs.forEach((url, i) => {
    const a = document.createElement('a');
    a.href = url; a.download = `imagen_${i+1}.png`;
    a.target = '_blank'; a.click();
  });
}

// â”€â”€ Label reprint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function reprintLabel(idx) {
  const item = filteredInventory[idx];
  const w = window.open('', '_blank', 'width=400,height=300');
  w.document.write(`<html><head><title>Label</title>
  <style>
    body{font-family:'Courier New',monospace;padding:20px;max-width:360px;}
    .label-box{border:3px solid black;padding:16px;border-radius:4px;}
    h2{font-size:22px;font-weight:900;margin:0 0 8px;}
    .row{display:flex;justify-content:space-between;margin-bottom:4px;font-size:13px;}
    .qr{text-align:center;font-size:40px;margin:10px 0;}
  </style></head>
  <body onload="window.print()">
    <div class="label-box">
      <h2>ğŸ“¦ ${item.sku}</h2>
      <div class="qr">â–â–€â–„â–Œ</div>
      <div class="row"><span>Cliente:</span><span>${clientMap[item.cliente_id]?.nombre||'â€”'}</span></div>
      <div class="row"><span>NÂ° Parte:</span><span>${item.numero_parte||'â€”'}</span></div>
      <div class="row"><span>Cantidad:</span><span>${item.cantidad||'â€”'}</span></div>
      <div class="row"><span>Tracking:</span><span style="font-size:11px;">${item.tracking_number||'â€”'}</span></div>
      <div class="row"><span>Fecha:</span><span>${fmtDate(item.fecha_entrada||item.created_at)}</span></div>
    </div>
  </body></html>`);
  w.document.close();
}

// â”€â”€ Lightbox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openLightbox(url) {
  document.getElementById('lightboxImg').src = url;
  document.getElementById('lightboxDownload').href = url;
  document.getElementById('lightboxModal').classList.add('open');
}
function closeLightbox() {
  document.getElementById('lightboxModal').classList.remove('open');
}

// â”€â”€ Day Detail Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function openDayModal(type) {
  currentDayType = type;
  const modal = document.getElementById('dayModal');
  const icon  = document.getElementById('dayModalIcon');
  const title = document.getElementById('dayModalTitle');
  const sub   = document.getElementById('dayModalSub');
  const body  = document.getElementById('dayModalBody');

  const start = dayStart();
  const end   = dayEnd();
  const today = new Date().toLocaleDateString('es-MX', { weekday:'long', day:'numeric', month:'long' });

  body.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-300);">â³ Cargando...</div>';
  modal.classList.add('open');

  if (type === 'entradas') {
    icon.textContent = 'ğŸ“¥'; icon.style.background = 'rgba(34,199,122,.1)';
    title.textContent = 'Entradas del DÃ­a';
    sub.textContent = today;

    let q = Q.from('inventario')
      .select(`sku, descripcion, cantidad, ubicacion, zona, created_at, folio_entrada, usuarios!operador_id(nombre,nombre_display), clientes(nombre)`)
      .gte('created_at', start).lte('created_at', end)
      .order('created_at', { ascending: false });
    if (USER.cliente_id) q = q.eq('cliente_id', USER.cliente_id);
    const data = await safeQuery(() => q);
    dayModalData = data || [];

    if (!data?.length) {
      body.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Sin entradas hoy</div></div>`;
      return;
    }

    body.innerHTML = `<div style="padding:4px 0;">` + data.map(r => {
      const op = r.usuarios?.nombre_display || r.usuarios?.nombre || 'Operador';
      return `<div class="day-item">
        <div class="day-item-time">${fmtTime(r.created_at)}</div>
        <div class="day-item-content">
          <div class="day-item-sku">${r.sku}</div>
          <div class="day-item-meta">${r.descripcion || 'â€”'} Â· Cantidad: ${r.cantidad||0}</div>
          <div class="day-item-meta">ğŸ“ ${r.ubicacion||r.zona||'Sin ubicaciÃ³n'}</div>
          <div class="day-item-by">ğŸ‘¤ ${op} Â· Folio: ${r.folio_entrada||'â€”'}</div>
        </div>
      </div>`;
    }).join('') + '</div>';

  } else if (type === 'salidas') {
    icon.textContent = 'ğŸ“¤'; icon.style.background = 'rgba(239,68,68,.08)';
    title.textContent = 'Salidas del DÃ­a';
    sub.textContent = today;

    // Get completed orden_items today
    const data = await safeQuery(() =>
      Q.from('orden_items')
        .select(`sku, descripcion, cantidad, confirmado_at, ordenes!orden_id(folio, transporte, sello, numero_orden, operador_id, usuarios!operador_id(nombre,nombre_display))`)
        .eq('confirmado', true)
        .gte('confirmado_at', start)
        .lte('confirmado_at', end)
        .order('confirmado_at', { ascending: false })
    );
    dayModalData = data || [];

    if (!data?.length) {
      body.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Sin salidas hoy</div></div>`;
      return;
    }

    body.innerHTML = `<div style="padding:4px 0;">` + data.map(r => {
      const ord = r.ordenes || {};
      const op = ord.usuarios?.nombre_display || ord.usuarios?.nombre || 'Operador';
      return `<div class="day-item">
        <div class="day-item-time">${fmtTime(r.confirmado_at)}</div>
        <div class="day-item-content">
          <div class="day-item-sku">${r.sku}</div>
          <div class="day-item-meta">${r.descripcion||'â€”'} Â· ${r.cantidad||1} ud</div>
          <div class="day-item-meta">ğŸš› ${ord.transporte||'â€”'} Â· Orden: ${ord.numero_orden||ord.folio||'â€”'} Â· Sello: ${ord.sello||'â€”'}</div>
          <div class="day-item-by">ğŸ‘¤ ${op}</div>
        </div>
      </div>`;
    }).join('') + '</div>';

  } else if (type === 'paqueteria') {
    icon.textContent = 'ğŸ“¦'; icon.style.background = 'rgba(139,92,246,.08)';
    title.textContent = 'PaqueterÃ­a del DÃ­a';
    sub.textContent = today;

    let q = Q.from('paqueteria')
      .select(`*, usuarios!operador_id(nombre,nombre_display), clientes(nombre)`)
      .gte('created_at', start).lte('created_at', end)
      .order('created_at', { ascending: false });
    if (USER.cliente_id) q = q.eq('cliente_id', USER.cliente_id);
    const data = await safeQuery(() => q);
    dayModalData = data || [];

    if (!data?.length) {
      body.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-text">Sin paqueterÃ­a hoy</div></div>`;
      return;
    }

    body.innerHTML = `<div style="padding:4px 0;">` + data.map(r => {
      const op = r.usuarios?.nombre_display || r.usuarios?.nombre || 'Operador';
      return `<div class="day-item">
        <div class="day-item-time">${fmtTime(r.created_at)}</div>
        <div class="day-item-content">
          <div class="day-item-sku">${r.codigo || r.tracking_number || 'â€”'}</div>
          <div class="day-item-meta">ğŸšš Carrier: ${r.carrier||'â€”'} Â· Bultos: ${r.bultos||1}</div>
          <div class="day-item-meta">ğŸ”– Tracking: ${r.tracking_number||'â€”'}</div>
          <div class="day-item-by">ğŸ‘¤ ${op} Â· Cliente: ${r.clientes?.nombre||'â€”'}</div>
        </div>
      </div>`;
    }).join('') + '</div>';
  }
}

function closeDayModal() {
  document.getElementById('dayModal').classList.remove('open');
}

function exportDayReport() {
  if (!dayModalData.length) return;
  exportXLSX(dayModalData, `reporte_${currentDayType}_${todayISO()}`);
}

// â”€â”€ Alerts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadAlerts() {
  const data = await safeQuery(() =>
    Q.from('alertas').select('*').eq('leida', false)
      .order('created_at', { ascending: false }).limit(20)
  );
  const count = data?.length || 0;
  const badge = document.getElementById('alertCount');
  if (count > 0) { badge.style.display = ''; badge.textContent = count > 9 ? '9+' : count; }
}

function openAlerts() {
  document.getElementById('alertsModal').classList.add('open');
  loadAlertsBody();
}
function closeAlerts() { document.getElementById('alertsModal').classList.remove('open'); }

async function loadAlertsBody() {
  const body = document.getElementById('alertsBody');
  body.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-300);">â³</div>';
  const data = await safeQuery(() =>
    Q.from('alertas').select('*').order('created_at', { ascending: false }).limit(30)
  );
  if (!data?.length) {
    body.innerHTML = '<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-text">Sin alertas</div></div>';
    return;
  }
  const lvlIcon = { info:'â„¹ï¸', warn:'âš ï¸', danger:'ğŸ”´' };
  body.innerHTML = data.map(a => `
    <div style="padding:12px 0;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:flex-start;">
      <span style="font-size:20px;">${lvlIcon[a.nivel]||'ğŸ“Œ'}</span>
      <div>
        <div style="font-size:13px;font-weight:700;color:var(--navy);">${a.titulo}</div>
        <div style="font-size:11px;color:var(--text-500);margin-top:2px;">${a.mensaje||''}</div>
        <div style="font-size:10px;color:var(--text-300);margin-top:3px;">${fmtDateTime(a.created_at)}</div>
      </div>
      ${!a.leida ? `<button style="margin-left:auto;font-size:10px;background:none;border:none;cursor:pointer;color:var(--success);"
        onclick="markAlertRead('${a.id}',this)">âœ“ LeÃ­da</button>` : ''}
    </div>`).join('');
}

async function markAlertRead(id, btn) {
  btn.disabled = true;
  await Q.from('alertas').update({ leida: true }).eq('id', id);
  btn.parentElement.style.opacity = '.5';
  loadAlerts();
}

// â”€â”€ Export all inventory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportInventory() {
  if (!filteredInventory.length) { showToast('Sin datos para exportar', 'warning'); return; }
  const rows = filteredInventory.map(i => ({
    SKU: i.sku, 'NÂ° Parte': i.numero_parte, DescripciÃ³n: i.descripcion,
    Cantidad: i.cantidad, Bultos: i.bultos, Peso: i.peso,
    PO: i.po, 'Serial Number': i.serial_number, 'Tracking Number': i.tracking_number,
    Vendor: i.vendor, Origin: i.origin, 'Part Model': i.part_model,
    Cliente: clientMap[i.cliente_id]?.nombre, AlmacÃ©n: almacenMap[i.almacen_id],
    UbicaciÃ³n: i.ubicacion || i.zona, Estado: i.estado,
    'Fecha Entrada': fmtDate(i.fecha_entrada || i.created_at),
  }));
  exportXLSX(rows, `inventario_${todayISO()}`);
  showToast('ğŸ“¥ Exportando inventario...', 'success');
}
</script>
</body>
</html>
